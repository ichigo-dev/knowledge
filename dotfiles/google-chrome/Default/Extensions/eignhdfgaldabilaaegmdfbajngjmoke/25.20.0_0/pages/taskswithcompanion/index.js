"use strict";cjce.registerTemplate("bm-p-taskswithcompanion",function(e,t){var c,i,n,a,s,o,l="https://mail.google.com",r="https://tasks.google.com",m="/"+t.wizPath+"embed/",h=r+m,m=cjgApis.companion.getInitData(),d=m.id,u=m.hash,_=m.parameters,m=cjBasics.uniqueId.generate(),p=cjBasics.lang.i18n("cj_i18n_06917","My Tasks"),b="list/",g="list/~default",j=g,f=[{id:g,label:p}],v=[],w="",k={bm_cid:"taskswithcompanion",bm_iid:m,bm_cst:"1",bm_wiz:"1",hl:cjBasics.lang.current,fullWidth:"1"};function A(e){e=cjBasics.urlParams.attach(h+(e||b),{fullWidth:"1",origin:l});t.openTab(e)}function C(e){e=e&&e.label||p;c.cjceSetPageLabel(e)}function T(){a=[{id:"list/~starred",label:cjBasics.lang.i18n("cj_i18n_00004","Starred"),iconName:"__mdi:star_border"}],f.forEach(function(e){e.iconName="__mdi:list_alt",e.newTabUrl=!0,e.id===j&&C(e),a.push(e)}),Array.isArray(v)&&0<v.length&&(a.push({header:!0,color:!0,label:cjBasics.lang.i18n("cj_i18n_06918","Rooms")}),v.forEach(function(e){e.iconName="__mdi:group",e.newTabUrl=!0,e.id===j&&C(e),a.push(e)}));var a,e=a,t=JSON.stringify(e.map(function(e){return[e.id,e.label]}));t!==w&&(w=t,t=cjce.createElement("bm-navlist",{isSelector:!0,selectedId:j,items:e,onChange:function(e,a){c.cjceSetLoading(!0),C(a),n.hidden=e.startsWith("room/")||e.startsWith("space/"),i.src=cjBasics.urlParams.attach(h+e,k)},onNewTab:function(e){A(e)}}),c.cjceDrawerEl.textContent="",c.cjceDrawerEl.appendChild(t))}function B(e,a){var t=a.indexOf(e);return a.slice(Math.max(0,t+e.length))}function I(e,a){e=a.lastIndexOf(e);return a.slice(0,Math.max(0,e))}function y(e){e=B("AF_initDataCallback({key: 'ds:1'",e),e=I("sideChannel:",B(" data:",e)),e=I("]",e)+"]",e=JSON.parse(e);return(e[5]||e[8]).map(function(e){return{id:"room/"+e[0][1],label:e[2]}})}function E(){i.cjceSendFrameCommand({method:"bmCstClickDomElement",value:'body > div > c-wiz > div[role="menu"] div[role="separator"] + [aria-label][role="menuitem"]'},r)}Object.keys(_).forEach(function(e){k[e]=_[e]}),c=cjce.createElement("bm-ogb",{loading:!0,drawer:!0,serviceIcon:"tasks",bmApis:t,onNewTab:function(){A(j)},serviceLabel:cjBasics.lang.i18n("cj_i18n_00439","Tasks"),pageLabel:p}),e.appendChild(c),n=cjce.createElement("ccbm-iconbutton",{iconName:"__mdi:post_add",label:cjBasics.lang.i18n("cj_i18n_06919","Create a new list"),onClick:function(){i.cjceSendFrameCommand({method:"bmCstClickDomElement",value:"h2 + div > div:first-child[data-allow-task-list-reordering] > div"},r),setTimeout(E),setTimeout(E,10),setTimeout(E,50),setTimeout(E,100),setTimeout(E,200),setTimeout(E,300),setTimeout(E,500)}}),c.cjceAppendChild(n),cjBasics.webRequest.handleIframeHeaders([r+"/*bm_iid="+m+"*"],{handleFirefoxInject:!0,handleSwCache:!0}),o=s=!1,a="https://chat.google.com/"+t.wizPath,cjBasics.ajax(a+"?shell=9").then(y).catch(function(){return cjBasics.ajax(a+"?shell=8").then(y)}).catch(function(){return[]}).then(function(e){o=!0,0<e.length&&cjgApis.cache.setItem(t.account,"bm_cache_v33__tasks__spaces",e),v=e,T()}),Promise.all([cjgApis.cache.getItem(t.account,"bm_cache_v33__tasks__activeview"),cjgApis.cache.getItem(t.account,"bm_cache_v33__tasks__tasklists"),cjgApis.cache.getItem(t.account,"bm_cache_v33__tasks__spaces")]).then(function(e){e[0]&&(j=e[0]);var a=e[1],a=(!s&&Array.isArray(a)&&0<a.length&&(f=a),e[2]);!o&&Array.isArray(a)&&0<a.length&&(v=a),T()}),m=cjBasics.urlParams.attach(h+b,k)+u,i=cjce.createElement("bm-iframe",{src:m,solid:"#fff",shadow:!0,sandbox:"allow-scripts allow-forms allow-same-origin allow-popups",onLoad:function(){c.cjceSetLoading(!1)},onMessage:function(e){var a;"object"==typeof e&&"taskswithcompanionData"===e.bm_method?(s=!0,a=e.bm_value,j=a.activeView||g,0<(a=a.tasklists).length&&(f=a,cjgApis.cache.setItem(t.account,"bm_cache_v33__tasks__tasklists",f)),j.startsWith("list/")&&cjgApis.cache.setItem(t.account,"bm_cache_v33__tasks__activeview",j),T()):(a=cjgApis.companion.handleOpenUrlMessage(e,d,t.account))&&t.openTab(a)}}),e.appendChild(i)});