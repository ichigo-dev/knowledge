# 『履歴の記録』

（最終更新： 2023-02-02）


## 目次

1. [Gitの各領域](#gitの各領域)
	1. [ワークツリー](#ワークツリー)
	1. [ステージ](#ステージ)
	1. [ローカルリポジトリ](#ローカルリポジトリ)
	1. [リモートリポジトリ](#リモートリポジトリ)
1. [状態の確認](#状態の確認)
	1. [省略表記](#省略表記)
1. [ステージング](#ステージング)
	1. [ハンク](#ハンク)
	1. [インタラクティブセッション](#インタラクティブセッション)
1. [ファイルの復元](#ファイルの復元)
	1. [ステージから復元](#ステージから復元)
1. [コミット](#コミット)
	1. [コミットメッセージ](#コミットメッセージ)
	1. [コミットの修正](#コミットの修正)


## Gitの各領域

### ワークツリー

**ワークツリー**（**ワーキングディレクトリ**）は、ファイルの編集作業を行うディレクトリ。この領域での変更内容はまだリポジトリに記録されていない状態となる。

### ステージ

**ステージ**（**インデックス**）は、変更履歴を作成するための中間領域。コミットに含めたいファイルやディレクトリは一時的にステージに移動する必要がある。

### ローカルリポジトリ

**ローカルリポジトリ**は、実際にコミット履歴が記録される領域。コミットしただけではリモートリポジトリには反映されず、あくまで自身のローカル環境でのみ履歴として追加される。また、複数のリモートリポジトリと紐づけることも可能。基本的にはノンベアリポジトリで運用される。

### リモートリポジトリ

**リモートリポジトリ**は、各ユーザのローカルリポジトリの変更を集約し、全体のコミット履歴を管理する領域。インターネットやサーバ上に用意するリポジトリで、開発者間で変更内容を共有したり、開発したプログラムをOSSとして公開するために用いられる。基本的にはベアリポジトリで運用される。


## 状態の確認

ワークツリー、ステージにあるファイルやディレクトリを確認したい場合は、 `git status` コマンドを用いる。

```sh
$ git status
```

特に変更がない場合は次のような出力となる。

```sh
$ git status
On branch main
Your branch is up to date with 'origin/main'.

nothing to commit, working tree clean
```

新しくファイルを追加した場合には次のような出力となる。

```sh
On branch main
Your branch is up to date with 'origin/main'.

Untracked files:
  (use "git add <file>..." to include in what will be committed)
        example.txt

no changes added to commit (use "git add" and/or "git commit -a")
```

ファイルに変更を加えた場合は次のような出力となる。

```sh
On branch main
Your branch is up to date with 'origin/main'.

Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git restore <file>..." to discard changes in working directory)
        modified:   example.txt

no changes added to commit (use "git add" and/or "git commit -a")
```

ステージングエリアにファイルが存在する場合は次のような出力となる。

```sh
On branch main
Your branch is up to date with 'origin/main'.

Changes to be committed:
  (use "git restore --staged <file>..." to unstage)
        modified:   example1.txt
        new file:   example2.txt
```

### 省略表記

`git status` コマンドでファイルのステータスを確認する際に、 `-s` オプションを指定することで、出力をコンパクトにすることができる。

```sh
M  example1.txt
 M example2.txt
?? example3.txt
```


## ステージング

**ステージング**は、履歴として記録したいワークツリーの変更内容を一時的にステージエリアに登録する操作。ステージングしただけでは変更は履歴に記録されないので注意が必要。

ステージングには、 `git add` コマンドを用いる。

```sh
# ファイル、ディレクトリのパスを指定してステージに移動
$ git add <path>

# 全ての変更をステージに移動
$ git add .
```

### ハンク

**ハンク**(Hank)は、ファイルの差分ブロックのこと。

### インタラクティブセッション

ステージングの際に、 `git add` コマンドに `-p` オプションを指定すると、インタラクティブなステージングセッションが開始される。このモードでは、順番に変更内容のハンクが表示され、 `y` を選択するとそのハンクをステージに移動し、 `n` を選択するとそのハンクを無視する。また、 `s` を選択するとハンクがさらに細かく分解され、 `e` を選択するとそのハンクを手作業で編集でき、 `q` を選択するとインタラクティブセッションを終了する。

```sh
$ git add -p
diff --git a/example.txt b/example.txt
index xxxxxxx..xxxxxxx 000000
--- a/example.txt
+++ b/example.txt
@@ -1,0 +1,1 @@
+Hello, Git!

(1/1) Stage this hunk [y,n,q,a,d,j,J,g,/,e,?]?
```


## ファイルの復元

指定したファイルの変更内容を取り消し、元の状態を復元したい場合は、 `git restore` コマンドを用いる。

```sh
# ファイル、ディレクトリのパスを指定して復元
$ git restore <path>

# 全ての変更を取り消し
$ git restore .
```

### ステージから復元

ステージの変更内容をワークツリーに戻したい場合は、 `git restore` コマンドに `--staged` オプションを指定する。

```sh
# ファイル、ディレクトリのパスを指定してステージからワークツリーに移動
$ git restore <path> --staged

# 全ての変更をステージからワークツリーに移動
$ git restore . --staged
```


## コミット

**コミット**は、ファイルやディレクトリの変更を履歴に記録する操作、あるいはその変更履歴のこと。リポジトリの変更履歴は**リビジョン**と呼ぶ場合もある。

Gitでは、コミットごとに差分のみ記録するのではなく、毎回すべてのファイルの**スナップショット**（ある時点でのソースコードやファイル、ディレクトリなどの状態を抜き出したもの）を作成している。差分のみを記録していると、古いリビジョンのファイルを復元するために履歴を全てたどる必要があるが、スナップショットを保存しておくことで高速に再現することができる。

コミットには、 `git commit` コマンドを用いる。

```sh
# 変更をコミット（エディタが開かれてコミットメッセージの入力に移る）
$ git commit

# コミットメッセージをインラインで指定してコミット
$ git commit -m "<message>"
```

### コミットメッセージ

**コミットメッセージ**は、コミット時に履歴に対してつけるコメントで、作業内容などを記録しておく。コミットメッセージの書き方には、開発チームごとに文化やルールなどが存在するが、次のようなフォーマットで記述するのが一般的。

- 1行目にコミットの概要を50文字以内（マルチバイト文字なら25文字）で記述
- 2行目は空行
- 3行目以降にコミットの詳細説明を記述
- コミットメッセージを英語で記述する場合、現在系の文章を使用
- コミットの概要には、適切なプレフィックスや絵文字をつける

### コミットの修正

直前のコミットのコミットメッセージを修正するには、 `git commit` コマンドに `--amend` オプションを指定する。

```sh
# 直前のコミットメッセージの修正
$ git commit --amend

# コミットメッセージをインラインで指定して修正
$ git commit --amend -m "<new-message>"
```

また、直前のコミットにファイルを追加したい場合は、追加したいファイルをステージングし、 `git commit` コマンドに `--amend` オプションと `--no-edit` オプションを指定する。ただし、この方法で直前にコミットしたファイルの編集や削除はできない。

```sh
# 対象ファイルをステージング
$ git add <path>

# 直前のコミットにステージのファイルを追加
$ git commit --amend --no-edit
```

この方法では、直前のコミットしか修正することができず、可能な操作も限られている。また、リモートリポジトリと同期済みのコミットを修正してはいけない（ `--amend` を用いると、実際には元のコミットとは別のコミットとして履歴が作られるため）。
