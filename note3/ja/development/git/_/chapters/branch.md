# 『ブランチ』

（最終更新： 2023-02-02）


## 目次

1. [ブランチ](#ブランチ)
	1. [ブランチの確認](#ブランチの確認)
	1. [ブランチの作成](#ブランチの作成)
	1. [ブランチの名前変更](#ブランチの名前変更)
	1. [ブランチの削除](#ブランチの削除)
	1. [ブランチの切り替え](#ブランチの切り替え)
1. [マージ](#マージ)
	1. [Fast-forwardマージ](#fast-forwardマージ)
	1. [3wayマージ](#3wayマージ)
	1. [コンフリクト](#コンフリクト)
	1. [リベース](#リベース)
1. [プルリクエスト](#プルリクエスト)


## ブランチ

**ブランチ**は、リポジトリのコミット履歴を分岐させる機能、あるいは枝分かれした流れのこと。一般的には管理の本流となるブランチを `master` ( `main` )とし、分岐させるブランチのことを**トピックブランチ**という。複数人が各自バグ修正や新機能の開発を並行して行うような場合に、各々がトピックブランチ上で作業を進めることで、他のユーザの作業に影響を受けることなく独立した状態を保つことができる。

### ブランチの確認

`git branch` は、リポジトリ上のブランチの一覧を表示するコマンド。オプションを指定しない場合はローカルリポジトリのブランチを、 `-r` オプションを指定するとリモートリポジトリのブランチを確認できる。また、 `-a` オプションを指定することで、ローカルリポジトリとリモートリポジトリの両方を一覧表示できる。

```sh
# ローカルリポジトリのブランチを一覧表示
$ git branch

# リモートリポジトリのブランチを一覧表示
$ git branch -r

# ローカルリポジトリとリモートリポジトリのブランチを一覧表示
$ git branch -a
```

### ブランチの作成

`git branch` コマンドの引数としてブランチ名を指定することで、新しいブランチを作成できる。

```sh
$ git branch <name>
```

### ブランチの名前変更

`git branch` コマンドに `-m` オプションを指定することで、ブランチ名を変更できる。

```sh
$ git branch -m <old-name> <new-name>
```

### ブランチの削除

`git branch` コマンドに `-d` オプションを指定することで、ブランチを削除できる。

```sh
$ git branch -d <name>
```

また、リモートリポジトリのブランチを削除したい場合は、 `git push` コマンドに `--delete` オプションを指定する。

```sh
$ git push <remote> --delete <branch>
```

### ブランチの切り替え

`git swtich` は、指定したブランチへの切り替えを行うコマンド。切り換え先の `HEAD` の内容がワークツリーに展開される。 `git swtich` コマンドに `-c` オプションを指定することで、新規ブランチの作成も同時に行える。

```sh
# 指定のブランチに切り替え
$ git switch <branch>

# 新規ブランチを作成して、そのままそのブランチに切り替え
$ git switch <branch> -c
```

また、1つ前のブランチを `-` で指定することもできる。

```sh
# 1つ前のブランチに切り替え
$ git switch -
```


## マージ

**マージ**は、あるブランチのヘッドを別のブランチに取り込む操作。トピックブランチの変更を本流となるブランチに統合したり、本流となるブランチの変更点をトピックブランチに取り込むといった使い方をする。

マージには `git merge` コマンドを用いる。まずは `HEAD` をマージ先のブランチに切り替え、 `git merge` コマンドの引数にマージしたいブランチ名を指定する。

```sh
# 現在のブランチに指定のブランチをマージ
$ git merge <branch>

# 具体例
$ git switch main
$ git merge develop
```

### Fast-forwardマージ

**Fast-forwardマージ**（**早送りマージ**）は、マージ先のブランチの `HEAD` からマージしたいブランチの `HEAD` に向かって1本の直線的なパスのみが通っている場合に適用される（マージしたいブランチ以外のブランチでコミットが行われていない状態でのマージ）。この場合は、実際には差分の統合が行われているわけではなく、マージ先の `HEAD` をマージしたいブランチの `HEAD` に移動する。これにより、実質的に全ての履歴が統合され、マージしたいブランチからアクセス可能であった全てのコミットがマージ先からも利用できるようになる。

### 3wayマージ

**3wayマージ**（**三方向マージ**）は、マージ先のブランチとマージしたいブランチの両方でコミットが行われており、単純なFast-forwardマージが実行できない場合に適用される。このマージ方法では、2つのブランチの `HEAD` を統合するような新たなマージコミットが作成される。

### コンフリクト

**コンフリクト**は、3wayマージの際に同じファイルの同じ行に対する変更があった場合や、片方のブランチで削除されたファイルに対してもう片方のブランチで編集を加えた場合などに、どちらの変更を優先すれば良いかを自動的に判断できなくなりマージに失敗すること。コンフリクトが発生した場合、コンフリクトが発生したファイルの該当箇所に以下のようなマークが追加される。

```sh
<<<<<<< HEAD
// マージ先のブランチの変更
aaa
=======
// マージしたいブランチの変更
bbb
>>>>>>> <branch>
```

この部分を統合したい形に編集して保存し、コミットを作成すると、コンフリクトしていたマージも完了した状態となる。また、 `git merge` コマンドに `--abort` オプションを指定することで、マージを中止することもできる。

```sh
$ git merge --abort
```

### リベース

**リベース**は、Fast-forwardマージができないような2つのブランチを、マージコミットを作成せずに統合する方法。統合先のブランチのコミット履歴の先頭に、統合元のブランチのコミット履歴の差分を全て直線的に追加する。これにより不要なマージコミットが除去され、履歴を汚さずに済む。ただし、リベースを行うと統合先のブランチのコミットを打ち消してしまう可能性があるので、本流となるブランチを自身が作業するトピックブランチに統合する場合などに限って利用すると良い。

リベースには `git rebase` コマンドを用いる。まずは `HEAD` を統合先のブランチに切り替え、 `git merge` コマンドの引数に統合したいブランチ名を指定する。

```sh
# 現在のブランチに指定のブランチをリベース
$ git rebase <branch>

# 具体例
$ git switch my-work-branch
$ git rebase main
```

また、 `git rebase` コマンドに `-i` オプションを指定することで、インタラクティブなリベースセッションを開始することができる。

```sh
# インタラクティブなリベースセッションを開始
$ git rebase main -i
```


## プルリクエスト

**プルリクエスト**は、ブランチのマージを他のユーザに通知し、マージを実行してよいか確認する機能。プルリクエストはGit自身の機能ではなく、GitHubなどのGitホスティングサービスにより提供されているため、環境によっては利用できない場合もある。

実装者はGitホスティングサービス上でマージしたいブランチを指定してプルリクエストを発行し、確認者がソースコードのレビューを行う。確認者がプルリクエストを承認すると実際にマージが実行される。プルリクエストを活用することで、このようなコードレビューのフローが実施しやすくなる。
