# 『インターネット層』

（最終更新： 2023-02-07）


## 目次

1. [IP](#ip)
1. [ルーティング](#ルーティング)
	1. [ホップ](#ホップ)
	1. [ルーティングテーブル](#ルーティングテーブル)
	1. [ホップバイホップルーティング](#ホップバイホップルーティング)
	1. [デフォルトルート](#デフォルトルート)
	1. [スタティックルーティング](#スタティックルーティング)
	1. [ダイナミックルーティング](#ダイナミックルーティング)
1. [フラグメンテーション](#フラグメンテーション)
	1. [経路MTU探索](#経路mtu探索)
1. [IPv4](#ipv4)
	1. [IPv4のフレームフォーマット](#ipv4のフレームフォーマット)
1. [IPv6](#ipv6)
	1. [IPv6のフレームフォーマット](#ipv4のフレームフォーマット)
1. [DNS](#dns)
	1. [ドメイン名](#ドメイン名)
	1. [ホスト名](#ホスト名)
	1. [FQDN](#fqdn)
	1. [ネームサーバ](#ネームサーバ)
	1. [ラウンドロビンDNS](#ラウンドロビンdns)
	1. [リゾルバ](#リゾルバ)
	1. [Aレコード](#aレコード)
	1. [NSレコード](#nsレコード)
	1. [MXレコード](#mxレコード)
1. [ARP](#arp)
	1. [RARP](#rarp)
	1. [GARP](#garp)
	1. [代理ARP](#代理arp)
1. [ICMP](#icmp)
	1. [ICMPv6](#icmpv6)
1. [DHCP](#dhcp)
1. [NAT](#nat)
	1. [NAPT](#napt)
	1. [NAT64/DNS64](#nat64-dns64)
	1. [CGN](#cgn)
	1. [NAT越え](#nat越え)
1. [IPトンネリング](#ipトンネリング)
1. [VRRP](#vrrp)
1. [IGMP](#igmp)
	1. [スヌーピング](#スヌーピング)
1. [ITエニーキャスト](#itエニーキャスト)
1. [QoS](#qos)
	1. [ふくそう](#ふくそう)
	1. [IntServ](#intserv)
	1. [DiffServ](#diffserv)
	1. [ECN](#ecn)
1. [Mobile IP](#mobile-ip)


## IP

**IP**(Internet Protocol)は、エンドノード間の通信を実現する役割を果たすインターネット層のプロトコル。IPはコネクションレス型の通信で、パケットを送信する前にコネクションの確立を行わない。パケットを宛先まで送り届けるために最大限努力を行うことから、**最善努力型（ベストエフォート）のサービス**と呼ばれている。接続の信頼性を高める役目を担うのはIPの上位層であるTCPで、これはコネクション型である。


## ルーティング

**ルーティング**（**経路制御**）は、宛先IPアドレスのホストまでパケットを届ける仕組み。

### ホップ

**ホップ**は、TCP/IPにおいて、ネットワークの1区間をIPパケットが移動すること。この1区間のことを**1ホップ**（**ワンホップ**）という。

### ルーティングテーブル

**ルーティングテーブル**（**経路制御表**）は、IPアドレスと対応するホストやルータの情報が書かれた表。IPでは、ルーティングテーブルを元にして次のホップを決める。

### ホップバイホップルーティング

**ホップバイホップルーティング**は、IPにおいて用いられているルーティングの方式で、最終目的地に行くまでの経路を各中継点（ホップ）で決定する方法。このため、パケットは行き当たりばったりに最終目的地に近づいていく。

### デフォルトルート

**デフォルトルート**は、ルーティングテーブルに経路情報がない宛先IPとの通信の際に選ばれる、次のホップ。

### スタティックルーティング

**スタティックルーティング**（**静的経路制御**）は、ルーティングテーブルをネットワーク管理者が手動で作成する方法。

### ダイナミックルーティング

**ダイナミックルーティング**（**動的経路制御**）は、他のルータとの通信の際に、経路情報を交換することで、自動的にルーティングテーブルを作成する方法。IP自体には経路情報を交換する機能は備わっていないので、ダイナミックルーティングを行う場合にはルーティングプロトコルが必要となる。


## フラグメンテーション

**フラグメンテーション**（**分割処理**）は、データリンクのMTUに合わせてパケットを分割する処理。パケットはルータを経由するたびに必要に応じてフラグメンテーションされ、宛先ホストにて復元される。経路の途中でフラグメンテーションが発生すると、分割されたデータの一部が失われただけで、全体の情報を再送する必要が出てきてしまうため、あらかじめ送信元ホストで経路全体のMTUにパケットを分割して送信することが多い。

### 経路MTU探索

**経路MTU探索**は、ICMPの到達不能メッセージを利用して、送信元のホストから宛先ホストまでの経路のMTUを探索する処理。これにより、フラグメンテーションの発生を防ぎながらも、最大効率でパケットを送信することができる。


## IPv4

**IPv4**は、インターネットの普及とともに広く使われるようになったIPの仕様で、IPアドレスを32ビットで表現する。インターネットの急速な普及によってIPアドレスが不足したため、IPv6への置き替えが進んでいる。

### IPv4のフレームフォーマット

**DSCPフィールド**は、初期の頃はサービスタイプ(TOS: Type Of Service)として定義されていた部分で、DiffServと呼ばれる品質制御に利用される。

**ECNフィールド**も同様にサービスタイプに置き換わって利用されているフィールドで、ネットワークがふくそうしていることを通知するために用いられる。


## IPv6

**IPv6**は、IPv4アドレスの枯渇問題を解決するために標準化されたIPの仕様。IPv4の4倍の16オクテット（128ビット）の長さを持ち、IPv4との互換性を保つ努力が行われている。 IPv6の特徴・目的は以下の通りである。

- IPアドレスの拡大と経路制御表の集約
- パフォーマンスの向上
- プラグ&プレイ機能を必須にする
- 認証機能や暗号化機能の採用
- マルチキャスト、Mobile IPの機能を拡張機能として提供

### IPv6のフレームフォーマット


## DNS

**DNS**(Domain Name System)は、ドメイン名とIPアドレスの対応を管理するシステム。ドメイン名から対応するIPアドレスを検索して、見つかったIPアドレスに対して

### ドメイン名

**ドメイン名**は、インターネット上の特定のネットワークを指す識別子。ネットワークだけでなく、コンピュータまでを指し示す場合もあり、この場合はホスト名やFQDNと混同される。

### ホスト名

**ホスト名**は、ネットワーク内の特定のコンピュータを指す識別子。

### FQDN

**FQDN**(Fully Qualified Domain Name)は、ドメイン名とホスト名を組み合わせた識別子で、インターネット上の特定のコンピュータを表す。FQDNはIPアドレスと対応させることができる。FQDNのことを単にドメイン名ということもある。

### ネームサーバ

**ネームサーバ**は、ドメイン名を管理するソフトウェアを動作させるホストのことで、そのネームサーバが設置された階層（ゾーン）のドメインに関する情報を管理している。**ルートネームサーバ**は、ネームサーバの階層のルート部分に設置されているサーバ。

### ラウンドロビンDNS

**ラウンドロビンDNS**は、1つのドメイン名に複数のIPアドレスを割り当てることができるDNS。

### リゾルバ

**リゾルバ**は、DNSに問い合わせをするためのソフトウェア。リゾルバのDNSに対する問い合わせを**クエリ**という。

### Aレコード

**Aレコード**は、DNSで管理される、ドメイン名とIPアドレスの対応レコード。

### NSレコード

**NSレコード**は、DNSで管理される、上位や下位のネームサーバのIPアドレスのレコード。

### MXレコード

**MXレコード**は、DNSで管理される、メールアドレスとそのメールを受信するメールサーバのホスト名の対応レコード。


## ARP

**ARP**(Address Resolution Protocol)は、アドレス解決のためのプロトコル。宛先IPアドレスを手掛かりにして、次にパケットを受け取るべき機器のMACアドレスを知りたいときに利用する。次のホップのルーターのMACアドレスを調べるために使用される。

ARPでは、最初にARP要求パケットをネットワークにブロードキャストする。このパケットには知りたいホストのIPアドレスが含まれており、該当するホストはARP応答パケットを返信する。

IPv6では、ARPの代わりにICMPv6の近接探索メッセージが利用されている。

### RARP

**RARP**(Reverse ARP)はARPの逆で、MACアドレスからIPアドレスを知りたい場合に使われる。RARPを使うにはRARPサーバーを用意する必要がある。

### GARP

**GARP**(Gratuitous ARP)は、自分のIPアドレスに対するMACアドレスを知りたい場合に使われる。IPアドレスの重複を確認したり、スイッチングハブなどのMACアドレス学習テーブルを更新させる働きがある。

### 代理ARP

**代理ARP**(Proxy ARP)はルーターなどの機能のひとつで、ネットワーク内の機器からのARP要求を、本来の機器に代わって返答すること。通常のARPは、同一セグメント内でIPパケットを配送するときに使われるが、代理ARPは、ルーティングテーブルを使わずにIPパケットを別のセグメントに送りたい場合に使われる。


## ICMP

**ICMP**(Internet Control Message Protocol)は、ネットワークが正常に動作しているかの確認や、異常が発生したときのトラブルシューティング（障害対策）を行うプロトコル。ICMPには、IPパケットが目的のホストまで届いたかどうかを確認する機能や、IPパケットが破棄されたときにその原因を通知する機能がある。

- ICMP 到達不能メッセージ
- ICMP リダイレクトメッセージ
- ICMP 時間経過メッセージ
- ICMP エコーメッセージ
- ICMP ルーター探索メッセージ
- ICMP 拡張エコーメッセージ

### ICMPv6

**ICMPv6**はIPv6用のICMPで、IPv6の通信を行う上でなくてはならないプロトコル。ICMPはIPv4においては補助的な役割でしかなかったが、ICMPv6はその役割がより重要なものとなっている。

特に近隣探索では、近隣探索メッセージをブロードキャストに対して送信し、近隣告知メッセージでMACアドレスを通知する。


## DHCP

**DHCP**(Dynamic Host Configuration Protocol)は、IPアドレスなどのネットワークへの接続に必要な情報を一括管理するプロトコル。特に、スマートフォンやラップトップPCなどの移動を伴う端末では、DHCPを用いることによりコンピュータのプラグ&プレイを実現している。

また、大規模なネットワークではたくさんのDHCPを管理することになるため、これらを一元管理するために**DHCPリレーエージェント**を用いる。


## NAT

**NAT**(Network Address Translator)は、ローカルなネットワークでプライベートIPアドレスを使用している機器がインターネットへ接続するときに、プライベートIPアドレスをグローバルIPアドレスに変換する技術。

NATには、次のような問題点がある。

- NATの外側から内側のサーバーに接続することはできない
- 変換テーブルの作成や変換処理にオーバヘッドが生じる
- 通信中にNATが異常動作して再起動した場合、すべてのTCPコネクションがリセットされる

### NAPT

**NAPT**(Network Address Ports Translator)は、IPアドレスだけではなく、TCPやUDPで用いるポート番号も付け替える技術。 モバイルルータやスマートフォンのテザリングは、NAPTを利用している。

現在では、NAPTのことを単にNAT、NATのことをベーシックNATと呼ぶことが多い。

### NAT64/DNS64

**NAT64/DNS64**は、DNSとNATが連携して動作することで、IPv6環境からIPv4環境への通信を実現するための技術。

### CGN

**CGN**(Carrier Grade NAT)は、ISPレベルでNATを行う技術。**LSN**(Large Scale NAT)と呼ばれることもある。

### NAT越え

**NAT越え**(NAT traversal)は、IPv6を使用する、NAT環境を前提としたアプリケーションを利用する、といった方法によってNATがあってもNATの外側と内側が通信できるようにする技術。


## IPトンネリング

**IPトンネリング**は、IPv4パケット全体を1つのデータとして扱い、その前にIPv6ヘッダを付与することで、IPv4環境同士の通信の間にIPv6環境のネットワークが介在するさせる技術。

IPトンネリングを使用すると、追加されるヘッダの分だけMTUが小さくなるため、**ジャンボフレーム**（1500バイト以上のペイロードを持つEthernetフレーム）の利用などの工夫が必要となる。


## VRRP

**VRRP**(Virtual Router Redundancy Protocol)は、デフォルトルータの故障やメンテナンス時にもネットワークが利用できるように、複数のルータによる冗長化を行う仕組み。スマートフォンやコンピュータは、デフォルトルーター（デフォルトゲートウェイ）を経由して社内LANやインターネットを利用する環境が一般的なので、VRRPによる冗長化が重要となる。

VRRPでは複数のルーターをまとめて運用し、その中の1つをマスタールーター、別のルーターをバックアップルーターとして扱う。マスタールーターは定期的にVRRPパケットをマルチキャストを使って送信する。バックアップルーターがこのVRRPパケットを3回連続で受け取れなかったとき、マスタールーターが故障したと判断してマスタールーターを切り替える。


## IGMP

**IGMP**(Internet Group Management Protocol)は、IPマルチキャストの通信において通信相手画いるかどうかを核にするためのプロトコル。マルチキャストではコネクションレスのUDPを用いるため、受信者がいなくてもネットワークを使用し続けてしまい、無駄が多くなる。これを防ぐためにIGMPが利用される。

また、IPv6においては**MLD**(Multicast Listener Discovery)が用いて受信者の確認を行う。

### スヌーピング

**IGMP(MLD)スヌーピング**では、スイッチングハブが通過するパケットを覗き見して、どのポートにどのアドレスのマルチキャストフレームを送ればよいかを知り、無関係なポートにはマルチキャストフレームを流さないようにする。


## IPエニーキャスト

**IPエニーキャスト**は、同じサービスを提供するサーバーに同じIPアドレスを付け、クライアントの最寄りのサーバーと通信できるようにする方法。代表例として、DNSルートサーバーが挙げられる。

IPエニーキャストでは、1つ目のパケットと2つ目のパケットが同じホストに届くという保証がない。そのため、最初の1パケットのみエニーキャストを用いて、それ以降はユニキャストを使うといった処理が行われる。


## QoS

**QoS**(Quality of Service)は、ネットワーク上のサービスの品質のこと。

### ふくそう

**ふくそう**（輻輳）は、ベストエフォートの通信において、通信回線が混雑すると性能が極端に低下するという問題のこと。

### IntServ

**IntServ**は、**RSVP**(Resource Reservation Protocol)エンドツーエンドできめ細かい優先制御を提供するための仕組み。必要な時にだけフローのセットアップを行って通信品質を制御する。RSVPは、パケットを受信する側から送信する側に向けて制御パケットを流し、その間に存在するルーターに品質制御のための設定を行う。

### DiffServ

**DiffServ**は、特定のネットワーク内で大雑把に通信品質を制御することが目的で、DiffServドメインの境界にあるルーターによってIPパケットのDSCPフィールドを書き換えることによって制御を行う。

### ECN

**ECN**(Explicit Congestion Notification)は、ふくそう通知機能を実現するための仕組み。ふくそうが起きている場合には、ホストはデータの送信量を減らす必要がある。


## Mobile IP

**Mobile IP**は、ホストが接続しているサブネットが変わっても、IPアドレスが変らないようにする技術。

- 移動ホスト(MH: Mobile Host)
- ホームネットワーク、ホームアドレス
- 気付けアドレス(CoA: Care-of Address)
- ホームエージェント(HA: Home Agent)
- 外部エージェント(FA: Foreign Agent)
