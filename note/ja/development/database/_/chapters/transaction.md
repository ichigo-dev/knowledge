# 『トランザクション』ノート

（最終更新： 2023-03-03）

## 目次

1. [トランザクション](#トランザクション)
	1. [コミット](#コミット)
	1. [ロールバック](#ロールバック)
	1. [セーブポイント](#セーブポイント)
1. [ロック](#ロック)
	1. [共有ロック](#共有ロック)
	1. [排他ロック](#排他ロック)
	1. [テーブルロック](#テーブルロック)
	1. [ページロック](#ページロック)
	1. [行ロック](#行ロック)
	1. [ロックタイムアウト](#ロックタイムアウト)
	1. [デッドロック](#デッドロック)
1. [アイソレーションレベル](#アイソレーションレベル)
	1. [シリアライザブル](#シリアライザブル)
	1. [リピータブルリード](#リピータブルリード)
	1. [リードアンコミッテッド](#リードアンコミッテッド)
	1. [リードコミッテッド](#リードコミッテッド)
	1. [ファントム](#ファントム)
	1. [ファジーリード](#ファジーリード)
	1. [ダーティリード](#ダーティリード)


## トランザクション

**トランザクション**は、複数のSQLを1つの作業単位としてまとめて実行すること。トランザクションはSQL文をグループ化するためのメカニズムであり、すべての文が成功したか、すべての文が失敗したかの2つの結果しか起こり得ない。

トランザクション中はロック機構などにより他のトランザクションが実行できなくなるが、トランザクションを並行して複数実行できるようにすることで処理が高速になる。

### コミット

**コミット**は、トランザクションが開始されてからの操作を確定し、トランザクションを終了する命令。

### ロールバック

**ロールバック**は、トランザクションが開始されてからの操作を取り消し、トランザクションを終了する命令。

### セーブポイント

**セーブポイント**は、トランザクションが異常終了してロールバックするときに、最初の状態まで戻すのではなく途中の状態に戻したいといった場合に用いる機能。


## ロック

**ロック**は、データリソースが同時に使用されることで整合性が失われることを防ぐため、トランザクションがデータリソースを占有すること。

ロックされているデータに対して、別のトランザクションがロックをかけようとした場合、前のロックが解除されるまで待機する必要がある。

### 共有ロック

**共有ロック**は、複数のトランザクションで共有することができるロックで、同じリソースの読み込みはできるが、書き込みはできない。

### 排他ロック

**排他ロック**は、ひとつのトランザクションによって占有されるロックで、他のトランザクションはリソースに対して読み込みも書き込みもできない。

### テーブルロック

**テーブルロック**は、テーブル内のすべてのデータを変更できないようにするロック。

### ページロック

**ページロック**は、テーブル内の同じページ（一般に2〜16KBのメモリセグメント）のデータを変更できないようにするロック。

### 行ロック

**行ロック**は、テーブル内の同じ行を変更できないようにするロック。

### ロックタイムアウト

**ロックタイムアウト**は、ロック中のデータに別のトランザクションがロックをかけようとしてロック待ちの状態となった場合に、待ち時間の上限となる時間。ロックタイムアウトがないと、デッドロックが発生したときにトランザクションが解除できなくなってしまう。

### デッドロック

**デッドロック**は、複数のトランザクションが互いにロックを掛け合うような状態となり、どちらのトランザクションもそれより先に処理を進めることができなくなる状態。デッドロックの状態となると、トランザクションはロックタイムアウトに達し、トランザクションが解除される（設定に応じた挙動となる。自動的にロールバックするなど）。


## アイソレーションレベル

**アイソレーションレベル**は、トランザクションの分離性のレベル。制限が厳しいものは並行に実行できるトランザクションが少なくなるため、安全性は高い。制限が緩いものは並行性が高く、高速な処理ができる一方で、データの不整合性が発生しないように注意する必要がある。

### シリアライザブル

**シリアライザブル**（**直列化可能**）は、最も厳しいアイソレーションレベルで、トランザクションは常に1つしか実行されない。データの整合性が失われたり、デッドロックとなるケースはない一方で、速度は遅い。

### リピータブルリード

**リピータブルリード**（**再読み込み可能読み取り**）は、シリアライザブルの次に厳しいアイソレーションレベルで、データの読み取り時と変更時にロックがかかり、トランザクションが終わるまでロックは解除されない。

シリアライザブルでは発生しないファントムが発生する可能性がある。ただし、RDBMSによってはファントムが発生しない。

### リードアンコミッテッド

**リードアンコミッテッド**（**コミット済み読み取り**）は、リードコミッテッドの次に緩いアイソレーションレベルで、データの読み取り時と変更時にロックがかかり、読み込み時はSQL実行後にロックが解除されるが、変更時はトランザクションが終わるまでロックが解除されない。

シリアライザブルでは発生しないファントムとファジーリードが発生する可能性がある。

### リードコミッテッド

**リードコミッテッド**（**非コミット読み取り**）は、最も緩いアイソレーションレベルで、データの変更時にロックがかかり、トランザクションが終わるまでロックが解除されない。読み込み時にはロックがかからない。

シリアライザブルでは発生しないファントムとファジーリードとダーティリードが発生する可能性がある。

### ファントム

**ファントム**は、トランザクション中である範囲のデータを読み込むクエリを複数回実行したときに、2回目以降の実行で最初の実行時よりもデータが増減する現象。リピータブルリード（あるいはリードアンコミッテッド）よりも緩いアイソレーションレベルでは、データの読み込み時に読み込むデータの行ロックを取るが、その行ロックの範囲外で別のトランザクションによりデータが挿入・削除される可能性があるため、ファントムが発生し得る。

### ファジーリード

**ファジーリード**（**ノーリピータブルリード**）は、トランザクション中で同じ読み込みのクエリを複数実行したときに、その結果が変わる現象。リードアンコミッテッドよりも緩いアイソレーションレベルでは、データの読み取り後にロックが解除されるため、別のトランザクションによってそのデータが変更されるとファジーリードが発生する。

### ダーティリード

**ダーティリード**は、あるトランザクションの変更がコミットされる前に、別のトランザクションから変更後の値を読み出せてしまう現象。リードコミッテッドでは、データの読み出し時にロックを獲得しようとしないため、ダーティリードが発生し得る。
