# 『シェルとターミナル』ノート

（最終更新： 2023-03-20）


## 目次

1. [シェル](#シェル)
	1. [ログインシェル](#ログインシェル)
	1. [プロンプト](#プロンプト)
	1. [sh](#sh)
	1. [bash](#bash)
	1. [ash](#ash)
	1. [zsh](#zsh)
	1. [csh](#csh)
	1. [tcsh](#tcsh)
1. [シェルの操作](#シェルの操作)
	1. [補間機能](#補間機能)
	1. [インクリメンタルサーチ](#インクリメンタルサーチ)
1. [シェルセッション](#シェルセッション)
1. [ターミナル](#ターミナル)
	1. [ターミナルエミュレータ](#ターミナルエミュレータ)
	1. [ターミナルマルチプレクサ](#ターミナルマルチプレクサ)
1. [エイリアス](#エイリアス)
1. [環境変数](#環境変数)
	1. [シェル変数](#シェル変数)
	1. [PATH](#path)
1. [設定ファイルの読み込み](#設定ファイルの読み込み)


## シェル

**シェル**は、ユーザとLinuxカーネルの橋渡しをするプログラムで、カーネルの機能をユーザに提供するためのインタフェース。シェルはまず、キーボードに入力されたユーザのコマンドを受け取り、カーネルに対して処理命令を行う。そして、カーネルの処理結果を受け取ってそれを出力する。シェルは、このようなやり取りを繰り返すインタラクティブな操作を提供する。

Linuxカーネルとシェルのレイヤを分離することにより、カーネルには手を入れずにシェルのみをユースケースに合わせて変更することができたり、別のOSを利用する際にシェルのみ移植すれば操作を同様に行える、といった利点がある。

### ログインシェル

**ログインシェル**は、ユーザがログイン時に最初にLinuxによって自動的に起動されるシェル。ログインシェルは、 `SHELL` 環境変数に指定されたコマンドで起動されるものとなる。ログインシェルを変更するには、 `chsh` コマンドを使用する。

```sh
# ログインシェルの確認
$ echo $SHELL
/bin/bash

# 利用できるシェルを一覧表示
$ chsh --list-shells
/bin/sh
/bin/bash
/usr/bin/git-shell
/bin/zsh
/usr/bin/zsh
/bin/rbash
/usr/bin/rbash

# ログインシェルの変更
$ chsh
Changing shell for user.
Password:
New shell [/bin/bash]: /bin/zsh
Shell changed.
```

### プロンプト

**プロンプト**は、シェルがユーザの入力を受け付けている状態を示す記号。多くの場合は `$` や `#` で表わされ、さらにログイン中のユーザ名やホスト名、カレントディレクトリなどの付加情報を表示することもできる。プロンプトの表示は、シェルの設定によりユーザが任意に変更できる。

Ubuntuのデフォルトのプロンプトは以下の通り。（ユーザ名が `user` 、ホスト名が `host` の場合）

```sh
user@host:~$
```

プロンプト記号の `$` は一般ユーザでの操作、 `#` はスーパユーザでの操作を例示しているドキュメントが多い。

また、長いコマンドなどの途中で `\` により改行された際には、**セカンダリプロンプト**が表示される。

### sh

**sh**(Bourne Shell)は、多くのUNIX系OSで標準的に使われているシェルのひとつで、古くからあり多くのシェルがshとの互換性を持っている。

### bash

**bash**(Bourne-Again Shell)は、GNUで開発されているオープンソースのシェル。sh互換だが様々な機能が追加されており、一時期はMacOSのシェルとしても採用されていた。多くのLinux環境でデフォルトのシェルとして採用されており、利用者が多いため情報を集めやすい。

### ash

**ash**(Almquist Shell)は、軽量かつ高速なsh互換のシェルで、Debian系のLinuxディストリビューションで利用されている。

### zsh

**zsh**(Z Shell)は、他のシェルの便利な機能を持ちつつ独自に進化しているsh互換でオープンソースのシェル。MacOSのデフォルトのシェルとしても採用されている。

### csh

**csh**(C Shell)は、BSD系のOSで使用されているシェルで、shとは異なり文法がC言語風となっている。

### tcsh

**tcsh**(TENEX C Shell)は、cshを拡張したオープンソースのシェルで、MacOSで採用されていたこともあったが、シェルスクリプトの記述には向いていないとされている。


## シェルの操作

シェルにはデフォルトで様々なキーバインドが設定されており、できるだけホームポジションから手を離さずに様々な操作ができるようになっている。シェルによっては対応していないものや、別のキーバインドが設定されているものもあるので注意。

| キーマップ   | 内容                                     |
| ------------ | :--------------------------------------- |
| `Ctrl` + `b` | 後方に1文字分移動する                    |
| `Ctrl` + `f` | 前方に1文字分移動する                    |
| `Ctrl` + `a` | 行頭に移動する                           |
| `Ctrl` + `e` | 行末に移動する                           |
| `Alt` + `b`  | 後方に単語1つ分移動する                  |
| `Alt` + `f`  | 前方に単語1つ分移動する                  |
| `Ctrl` + `h` | カーソル位置の後方に1文字削除する        |
| `Ctrl` + `d` | カーソル位置の1文字を削除する            |
| `Ctrl` + `w` | 後方にスペース区切りで1単語分を削除する  |
| `Ctrl` + `k` | カーソル位置から行末までを削除する       |
| `Ctrl` + `u` | カーソル位置から行頭までを削除する       |
| `Ctrl` + `y` | 最後に削除した内容を挿入する             |
| `Ctrl` + `s` | 画面表示をロックする                     |
| `Ctrl` + `q` | 画面表示のロックを解除する               |
| `Ctrl` + `c` | 実行中のコマンドを強制終了する           |
| `Ctrl` + `l` | 画面を消去する                           |
| `Ctrl` + `p` | 1つ前のコマンド履歴に移動する            |
| `Ctrl` + `n` | 1つ後のコマンド履歴に移動する            |
| `Ctrl` + `r` | コマンド履歴をインクリメンタルサーチする |

### 補間機能

多くのシェルでは、 `Tab` キーを押下することで補間機能が利用できる。途中まで入力したコマンドや、パスの候補をシェルが自動で入力してくれる。また、複数の候補がある場合には、その候補を画面上に出力してくれる。

### インクリメンタルサーチ

**インクリメンタルサーチ**は、キーボードから1文字入力するごとにコマンド履歴を検索する機能。インクリメンタルサーチモード中は、次のようなキーバインドが利用できる。

| キーマップ   | 内容                                               |
| ------------ | :------------------------------------------------- |
| `Ctrl` + `r` | 1つ前の検索結果へ移動                              |
| `Enter`      | 現在の検索結果をそのまま実行                       |
| `Esc`        | 現在の検索結果を表示したまま、コマンドラインに戻る |
| `Ctrl` + `g` | 検索結果を破棄し、プロンプトに戻る                 |


## シェルセッション

**シェルセッション**は、ユーザがシェルにログインしてからシェルを閉じるまでの一連の流れ。セッションが開始されると、シェルは設定を読み込んでユーザにプロンプトを返し、コマンドを入力できる状態となる。セッションは、ユーザがログアウトするか、システムが再起動されると終了する。


## ターミナル

**ターミナル**（**端末**）は、ユーザがコンピュータへ入出力する際に利用するハードウェアを指す言葉。入力装置にはキーボード、出力装置にはディスプレイが主に用いられる。

ターミナルエミューレタのことを単にターミナルと呼ぶ場合もある。

### ターミナルエミュレータ

**ターミナルエミュレータ**は、ターミナルをソフトウェアによって再現したもの。入出力画面を提供するインタフェースで、シェルはターミナルエミュレータ上で動作する。代表的なターミナルエミュレータとしては、WindowsのTeraTermやRLogin、macOSのiTerm2、各環境で動作するAlacrittyなどがある。

遠隔のコンピュータを操作する場合、接続元ではターミナルエミュレータが、接続先ではシェルが動作することになる。

### ターミナルマルチプレクサ

**ターミナルマルチプレクサ**は、1つのターミナルを複数の仮想ターミナルに分割して、同時に複数のターミナルを実行できるようにするツール。特に有名なターミナルマルチプレクサとしては、 `tmux` がある。リモートアクセスなどによりLinuxを利用する場合、コネクションが切断されたときに前のセッションを復元することができたり、複数のコネクションを張ることなくマルチターミナルで作業ができるといった利点がある。

### TTY

**TTY**(Teletypewriter)は、物理的な端末デバイスを表す用語で、キーボードと画面からなるターミナルの接続を表すデバイスファイル。

### PTY

**PTY**(Pseudo terminal)は、仮想的な端末デバイスを表す用語で、ターミナルエミュレータやSSHなどのアプリケーションで使用される。**PTS**(Pseudo terminal slave)と呼ぶ場合もある。

## エイリアス

**エイリアス**は、既存のコマンドに対して別名をつけて実行できるようにする機能。

例えば以下のようなエイリアスを設定すると、 `ls` コマンドを実行したときに `-F` オプションが自動で付与されるようになる。

```sh
$ alias ls='ls -F'
```

あるコマンドが、本当にコマンドであるかエイリアスであるかを確認するには、 `type` コマンドを使用する。

```sh
$ type ls
ls is an alias for ls -F
```

また、エイリアスを削除するには `unalias` コマンドを使用する。

```sh
$ unalias ls
```

`command` コマンドを使用したり、コマンドの先頭に `\` を付与することで、一時的にエイリアスを無視して元のコマンドを実行することもできる。

```sh
$ command ls
$ \ls
```


## 環境変数

**環境変数**は、Linuxにおいてシステム全体に影響を与える変数のことで、主にシェルの振る舞いを制御するために使用される。環境変数はプロセスが実行されるときにプロセスに渡され、そのプロセスの動作を変更することができる。環境変数は以下のような場合に利用される。

- ユーザの設定やシステムの設定を制御する
- プログラムが必要とするパスやライブラリの場所を指定する
- 各ユーザのシェルの動作をカスタマイズする

以下のコマンドを実行すると、 `MY_VAR` という変数に `avlue` という値を設定することができる。

```Sh
$ export MY_VAR=value
```

また、環境変数を確認するには、以下のコマンドを実行する。

```sh
$ echo $MY_VAR
```

環境変数の設定はシェルセッションが終了すると消えるので、永続化したい場合はシェルの設定ファイル内などで定義しておくとよい。

### シェル変数

**シェル変数**は、シェル内でのみ使用される変数で、そのシェル自体とその子プロセスでのみ使用される。シェル変数は環境変数とは異なり、他のプログラムには影響を与えない。

シェル変数を設定するには、以下の例のようにシェル変数名と値を等号で結ぶ。

```sh
$ MY_SHELL_VAR=value
```

### PATH

`PATH` は、シェルがコマンドを実行する際に検索するディレクトリのリストを含む環境変数。 `PATH` には、シェルがコマンドを検索する順序で、コロンで区切られたディレクトリのリストが格納される。

例えば、 `PATH` が `/usr/local/bin:/usr/bin:/bin` に設定されている場合、シェルはまず `/usr/local/bin` を検索し、次に `/usr/bin` を検索し、最後に `/bin` を検索する。

`PATH` 環境変数を修正することで、独自定義のコマンドをどこからでも実行できるようにしたりすることができる。


## 設定ファイルの読み込み

`source` は、指定されたシェルスクリプトを現在のシェルセッションで実行し、そのシェルスクリプト内で定義された変数や関数、設定等を有効にするコマンド。

例えば次のコマンドを実行すると、ホームディレクトリにあるbashの設定ファイルである `.bashrc` を現在のシェルに読み込む。

```sh
$ source ~/.bashrc
```
