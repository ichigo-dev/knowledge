# 『シェルスクリプト』ノート

（最終更新： 2023-03-17）


## 目次

1. [シェルスクリプト](#シェルスクリプト)
	1. [シバン](#シバン)
	1. [シェルスクリプトの実行](#シェルスクリプトの実行)
1. [シェルスクリプトの書き方](#シェルスクリプトの書き方)
	1. [コメント](#コメント)
	1. [変数](#変数)
	1. [クォーティング](#クォーティング)
	1. [コマンド置換](#コマンド置換)
	1. [位置パラメータ](#位置パラメータ)


## シェルスクリプト

**シェルスクリプト**は、OSに対して実行したい一連のコマンドを並べ、まとめて実行できるようにしたファイル、あるいはそれを記述するためのスクリプト言語。シェルでは通常、コマンドの実行と結果の表示を対話的に繰り返すが、シェルスクリプトを使用すると、コマンドの打ち間違いを減らしたり、再利用性や再現性を高めることができる。

シェルスクリプトが記述されたファイルは、拡張子を `.sh` とするのが一般的で、実行権限を付けておく必要がある。

例えば、以下のシェルスクリプトは、ホームディレクトリの合計ディスク容量を出力する。

```sh
#!/bin/bash
du -h ~ | tail -n 1
```

ファイルに実行権限を付け、ファイル名の前に `./` をつけることで、このシェルスクリプトを実行できる。

```sh
$ chmod +x homesize.sh
$ ./homesize.sh
```

また、 `source` コマンドを用いて実行することもできる。

### シバン

**シバン**(Shebang)は、シェルスクリプトファイルをどのシェルで実行するかを宣言する部分で、先頭行に記述する。 `#!` に続けて、 `/bin/bash` のように使用するシェルのパスを記述する。

例えば、以下のようなシバンが記述されたシェルスクリプトを実行すると、bashシェルを使用してスクリプトを実行する。

```sh
#!/bin/bash
```

### シェルスクリプトの実行

`source` は、指定したファイルを現在のシェルで実行するコマンド。 `./` を用いる場合とは異なり、現在のシェルにそのままコマンドを流し込むかたちとなるので、ファイルにシバンを記述する必要はない。また、ファイル自体に実行権限を付与しなくてもよい。

以下は、 `homesize.sh` というシェルスクリプトを `source` を用いてカレントシェルで実行する例。

```sh
$ source homesize.sh
```

`source` コマンドはカレントシェルによりコマンドを実行した場合と同じ動作になるため、カレントシェルの環境の影響を受けたり、実行後にカレントシェルに影響を及ぼすことに注意が必要。


## シェルスクリプトの書き方

### コメント

シェルスクリプト内では、 `#` の後ろすべてがコメントとして扱われる。プログラムの内容に関する補足を記述したり、一時的に無効化したい行をコメントアウトしたりする目的で用いられる。

```sh
#!/bin/bash

echo "Example Script"

# ルートディレクトリに移動
cd /

ls -l    # ファイルの一覧を表示
```

### 変数

シェルスクリプトでは、シェル変数や環境変数といった変数を用いることができる。変数に値を代入するには、 `<変数名>=<値>` という形式で記述する。 `=` の前後にはスペースを入れないように注意する。

```sh
#!/bin/bash

var="value"
```

また、変数の値を参照する際には、変数名の前に `$` をつける。

```sh
#!/bin/bash

work_dir="~/workspace"
cd $work_dir
```

変数名と別の文字列をつなげて書きたい場合は、変数名を `{}` で囲んで記述する。

```sh
#!/bin/bash

backup_file="~/test.txt"
cp $backup_file ${backup_file}.bak
```

一般的には、環境変数はアッパーケース、シェル変数はスネークケースで定義する場合が多い。

### クォーティング

シェルスクリプト中で文字列をクォートで囲むと、スペースも含めて1つの単語としてみなされるようになる。一般的なプログラミング言語とは異なり、すべての文字列をクォートで囲む必要はない。

シングルクォートを用いた場合は変数展開が無効となり、ダブルクォートを用いた場合は変数展開が行われる。また、ダブルクォートを用いた場合でも、 `$` の前に `\` を記述してエスケープすることで変数展開を防ぐことができる。

```sh
#!/bin/bash

user_name=Malia
echo 'Hello, $user_name'    # 変数展開されない
echo "Hello, $user_name"    # 変数展開される
echo "Hello, \$user_name"   # 変数展開されない
```

### コマンド置換

**コマンド置換**は、コマンドの結果を文字列として取得する機能。 `$()` という形式が用いられ、コマンドの出力結果をシェルスクリプト内で利用したい場合に用いられる。

```sh
#!/bin/bash

$filename=$(date '+%Y-%m-%d')
touch $filename
```

### 位置パラメータ

**位置パラメータ**は、シェルスクリプトからコマンドライン引数を扱うためのシェル変数。

例えば、以下のようにシェルスクリプトを実行したとする。

```sh
$ ./backup.sh ./src ./src.bak
```

このとき、シェルスクリプトの中ではこれらの引数を次のように受け取ることができる。

```sh
#!/bin/bash

$backup_from=$1
$backup_to=$2
cp -r $backup_from $backup_to
```

引数は1つ目から順番に、 `$$1, $2, $3...` という変数名に割り当てられる。また、 `$0` には実行されたシェルスクリプト名が格納される。さらに、引数の個数を表す特別なパラメータとして `$#` が、全ての引数をまとめたものとして `$@` あるいは `$*` が用いられる。

| 変数            | 内容                                                                                             |
| --------------- | :----------------------------------------------------------------------------------------------- |
| `$0`            | 実行時のシェルスクリプト名                                                                       |
| `$1, $2, $3...` | コマンドライン引数の値（位置パラメータ）                                                         |
| `$#`            | 位置パラメータの個数                                                                             |
| `$@`            | 全ての位置パラメータで、ダブルクォートで囲むとそれぞれの位置パラメータがダブルクォートで囲まれる |
| `$*`            | 全ての位置パラメータで、ダブルクォートで囲むと全体が一つの文字列としてダブルクォートで囲まれる   |
