# 『トランスポート層』ノート

（最終更新： 2023-06-27）


## 目次

1. [TCP](#tcp)
	1. [ストリーム](#ストリーム)
    1. [スリーウェイハンドシェイク](#スリーウェイハンドシェイク)
	1. [確認応答](#確認応答)
	1. [否定確認応答](#否定確認応答)
	1. [シーケンス番号](#シーケンス番号)
	1. [TCPのフレームフォーマット](#tcpのフレームフォーマット)
1. [UDP](#udp)
	1. [UDPのフレームフォーマット](#udpのフレームフォーマット)
1. [ソケット](#ソケット)
1. [MSS](#mss)
1. [ウィンドウ](#ウィンドウ)
	1. [ウィンドウサイズ](#ウィンドウサイズ)
	1. [ウィンドウ制御](#ウィンドウ制御)
	1. [スライディングウィンドウ](#スライディングウィンドウ)
1. [フロー制御](#フロー制御)
	1. [ウィンドウプローブ](#ウィンドウプローブ)
1. [ふくそう制御](#ふくそう制御)
	1. [バースト](#バースト)
	1. [スロースタート](#スロースタート)
1. [Nagleアルゴリズム](#nagleアルゴリズム)
1. [シリーウィンドウシンドローム](#シリーウィンドウシンドローム)
	1. [遅延確認応答](#遅延確認応答)
1. [ピギーバック](#ピギーバック)
1. [QUIC](#quic)
1. [SCTP](#sctp)
	1. [マルチホーミング機能](#マルチホーミング機能)
1. [DCCP](#dccp)
1. [UDP-Lite](#udp-lite)


## TCP

**TCP**(Transmission Control Protocol)は、[コネクション型](./network.md#コネクション型)で信頼性のあるストリーム型の[プロトコル](./network_architecture.md#プロトコル)。[ネットワーク](./network.md#ネットワーク)の途中で[パケット](./network.md#パケット)が喪失した場合の再送制御や、順序が入れ替わった場合の順序制御などを行う。

- 信頼性が必要な通信
- [インターネット](./network.md#インターネット)を介して大量のデータを転送する場合
- ビデオオンデマンドやライブ配信といった、即時性がそれほど必要ない動画や音声の再生（ストリーミング）

### ストリーム

**ストリーム**は、連続していて切れ目のないデータ構造。

### スリーウェイハンドシェイク

**スリーウェイハンドシェイク**は、[TCP](#tcp)における[コネクション](./network.md#コネクション)の確立方法で、合計で3回の[パケット](./network.md#パケット)をやり取りすることからこのような名前となっている。

### 確認応答

**確認応答**(**ACK**)は、[TCP](#tcp)において、送信したデータが受信[ホスト](./network.md#ホスト)に到達したときに、受信[ホスト](./network.md#ホスト)が送信[ホスト](./network.md#ホスト)に対してデータが到達したことを知らせる[パケット](./network.md#パケット)。

### 否定確認応答

**否定確認応答**(**NACK**)は、[TCP](#tcp)において、送信したデータが受信[ホスト](./network.md#ネットワーク)に正しく伝わらなかった時に、受信[ホスト](./network.md#ホスト)が送信[ホスト](./network.md#ホスト)に対してそのことを知らせる[パケット](./network.md#パケット)。

### シーケンス番号

**シーケンス番号**は、[TCP](#tcp)で送信される[パケット](./network.md#パケット)につけられる通し番号。受信[ホスト](./network.md#ホスト)は、送信[ホスト](./network.md#ホスト)の再送処理などにより、重複したデータを受け取る可能性がある。シーケンス番号は、このような重複した[パケット](./network.md#パケット)を識別して破棄するためにも利用される。

### タイムアウト

**タイムアウト**は、ある一定の時間が経過しても、受信[ホスト](./network.md#ホスト)から[確認応答](#確認応答)が返ってこずに、接続の確立に失敗するエラー。タイムアウトが発生した場合、送信[ホスト](./network.md#ホスト)はデータが喪失したと判断して再送処理を行う。[確認応答](#確認応答)の到着を待つ時間を**再送タイムアウト時間**という。再送タイムアウト時間を決めるため、[パケット](./network.md#パケット)を送信する度に通信の[ラウンドトリップタイム](../../../system/_/chapters/system_performance_evaluation.md#ターンアラウンドタイム)と[ジッタ](../../../system/_/chapters/system_performance_evaluation.md#ジッタ)を計算する。

### TCPのフレームフォーマット


## UDP

**UDP**(User Datagram Protocol)は、[コネクションレス型](./network.md#コネクションレス型)で信頼性のない[プロトコル](./network_architecture.md#プロトコル)。高速性やリアルタイム性を重視する通信や同報通信を行いたい場合に利用する。

- 総[パケット](./network.md#パケット)が少ない通信（[DNS](./internet_layer.md#dns)、[SNMP](./application_layer.md#snmp)など）
- 動画や音声などの[マルチメディア](../../../computer/software/_/chapters/multimedia.md#マルチメディア)通信（即時性が必要な通信）
- [LAN](./network.md#lan)などの特定の[ネットワーク](./network.md#ネットワーク)に限定した[アプリケーション](../../../computer/software/_/chapters/software.md#応用ソフトウェア)の通信
- 同報性が必要な通信（[ブロードキャスト](./network.md#ブロードキャスト)、[マルチキャスト](./network.md#マルチキャスト)）

### UDPのフレームフォーマット


## ソケット

**ソケット**は、[TCP](#tcp)や[UDP](#udp)を利用して通信を行うために広く使われている[API](../../../computer/software/_/chapters/operating_system.md#api)。[アプリケーション](../../../computer/software/_/chapters/software.md#応用ソフトウェア)はソケットを利用して、通信相手の[IPアドレス](./address_on_network.md#ipアドレス)や[ポート番号](./address_on_network.md#ポート番号)の設定、データの送受信の要求を行う。


## MSS

**MSS**（Maximum Segment Size: **最大セグメント長**）は、[TCP](#tcp)[パケット](./network.md#パケット)におけるペイロード（[TCP](#tcp)ヘッダは含まない）の最大長。MSSは、[コネクション](./network.md#コネクション)確立時に決定される。


## ウィンドウ

**ウィンドウ**は、[TCP](#tcp)におけるデータ転送を[ウィンドウ制御](#ウィンドウ制御)によって行うときの、データ転送の単位。複数の[セグメント](./datalink_layer.md#セグメント)をひとつにまとめたもの。

### ウィンドウサイズ

**ウィンドウサイズ**は、[TCP](#tcp)におけるデータ転送を[ウィンドウ制御](#ウィンドウ制御)によって行うときに用いられる、[ウィンドウ](#ウィンドウ)の大きさ。

### ウィンドウ制御

**ウィンドウ制御**は、[TCP](#tcp)において効率よく[パケット](./network.md#パケット)を伝送するための仕組み。複数の[セグメント](./datalink_layer.md#セグメント)をまとめた[ウィンドウ](#ウィンドウ)を送信することで、毎回[確認応答](#確認応答)を待たずに連続したデータを送信できる。

### スライディングウィンドウ

**スライディングウィンドウ**は、[確認応答](#確認応答)を受け取った分だけ[ウィンドウ](#ウィンドウ)をずらして、次々とデータを転送していく方法。[ウィンドウ制御](#ウィンドウ制御)では複数の[セグメント](./datalink_layer.md#セグメント)に対してまとめて[確認応答](#確認応答)をしているが、スライディングウィンドウでは全ての[セグメント](./datalink_layer.md#セグメント)に対して[確認応答](#確認応答)が行われるため、信頼性を損なわない。


## フロー制御

**フロー制御**は、受信側の受信能力に合わせて[パケット](./network.md#パケット)送信量を制御する方式。

受信[ホスト](./network.md#ホスト)は、受信可能なバッファサイズを[TCP](#tcp)ヘッダのフィールドに入れて送信[ホスト](./network.md#ホスト)に送る。このフィールドの値が大きいほど[スループット](../../../system/_/chapters/system_performance_evaluation.md#スループット)が大きく、高い効率での通信が可能になる。

受信[ホスト](./network.md#ホスト)はバッファがいっぱいになると、送信[ホスト](./network.md#ホスト)に対してデータの送信停止を要求する。停止したデータのやり取りを再開するために、送信[ホスト](./network.md#ホスト)は[ウィンドウプローブ](#ウィンドウプローブ)と呼ばれる[セグメント](./datalink_layer.md#セグメント)を時々送信する。

### ウィンドウプローブ

**ウィンドウプローブ**は、一時停止したデータ送信を再開するため、受信[ホスト](./network.md#ホスト)のバッファに空きがあるかを確認する[セグメント](./datalink_layer.md#セグメント)。


## ふくそう制御

**ふくそう制御**は、[ネットワーク](./network.md#ネットワーク)が混雑することを防ぐための制御。

### バースト

**バースト**は、連続的に[パケット](./network.md#パケット)が送信されることによって、トラフィックが混雑し、[ふくそう](./internet_layer.md#ふくそう)状態となる現象。

### スロースタート

**スロースタート**は、[TCP](#tcp)において、通信開始時は送信量を抑えておき、徐々に増やしていく方式。送信側でデータの送信量を調整するための**ふくそうウィンドウ**を定義しておき、最初はこの[ウィンドウ](#ウィンドウ)の大きさを1[セグメント](./datalink_layer.md#セグメント)に設定しておく。[確認応答](#確認応答)されるたびに1[セグメント](./datalink_layer.md#セグメント)ずつ[ウィンドウ](#ウィンドウ)を大きくしていき、[タイムアウト](#タイムアウト)が発生した際には、ふくそうウィンドウを1にして再度スロースタートをやり直す。


## Nagleアルゴリズム

**Nagleアルゴリズム**は、[ネットワーク](./network.md#ネットワーク)の利用効率を高めるために[TCP](#tcp)で用いられている[アルゴリズム](../../../programming/_/chapters/algorithm.md#アルゴリズム)。その瞬間に送信側に送信すべきデータがあったとしても、そのデータが少ない場合にはすぐに送信せずに遅延させる。通信が遅延してほしくないような場合には、この[アルゴリズム](../../../programming/_/chapters/algorithm.md#アルゴリズム)を無効にする。


## シリーウィンドウシンドローム

**シリーウィンドウシンドローム**(SWS: Silly Window Syndrome)は、データを受信した[ホスト](./network.md#ホスト)が即座に[確認応答](#確認応答)をすることで、次々にデータを受信してしまい、バッファがいっぱいになる現象。

### 遅延確認応答

**遅延確認応答**は、[シリーウィンドウシンドローム](#シリーウィンドウシンドローム)を防ぐため、[確認応答](#確認応答)のタイミングを遅延させる方法。


## ピギーバック

**ピギーバック**は、[確認応答](#確認応答)と[レスポンス](../../../system/_/chapters/system_processing_model.md#レスポンス)のデータ[パケット](./network.md#パケット)を1つの[パケット](./network.md#パケット)として送る方法。


## QUIC

**QUIC**(Quick UDP Internet Connection)は、Googleによって提案され、[標準化](./communication_protocol.md#標準化の流れ)が進められている[プロトコル](./network_architecture.md#プロトコル)。[TCP](#tcp)には暗号化の機能はないが、QUICはそれ自体で暗号化通信を可能にする。

QUICは[UDP](#udp)を使用するため、[UDP](#udp)とQUICを合わせてトランスポートプロトコルの役割を果たす。QUICの特徴は次の通り。

- 認証、暗号化
- 低遅延の[コネクション](./network.md#コネクション)管理
- 多重化（1[コネクション](./network.md#コネクション)で複数の[ストリーム](#ストリーム)を同時に扱う）
- 高精度な再送処理
- [コネクション](./network.md#コネクション)のマイグレーション（[IPアドレス](./address_on_network.md#ipアドレス)が変わっても[コネクション](./network.md#コネクション)を維持する）

[TCP](#tcp)では[コネクション](./network.md#コネクション)の確立だけで3回（[スリーウェイハンドシェイク](#スリーウェイハンドシェイク)）、TLSによる通信の暗号化を行う場合は7回の[パケット](./network.md#パケット)のやり取りが必要であったが、QUICでは1回の[パケット](./network.md#パケット)のやり取りで実現できる。


## SCTP

**SCTP**(Stream Control Transmission Protocol)は、[TCP](#tcp)と同様、データの到達に関する信頼性を提供する[プロトコル](./network_architecture.md#プロトコル)。[マルチホーミング機能](#マルチホーミング機能)をサポートしている。

### マルチホーミング機能

**マルチホーミング機能**は、複数の[NIC](./network.md#nic)がついている[ホスト](./network.md#ホスト)で、[NIC](./network.md#nic)が変わっても通信が継続できる機能。


## DCCP

**DCCP**(Datagram Congestion Control Protocol)は、[UDP](#udp)を補う[プロトコル](./network_architecture.md#プロトコル)で、データの到達性に関する信頼性はないものの、[コネクション型](./network.md#コネクション型)で[コネクション](./network.md#コネクション)の確立と切断に関する信頼性を持つ。


## UDP-Lite

**UDP-Lite**(Lightweight UDP)は、[UDP](#udp)とほぼ同じ機能を提供する[プロトコル](./network_architecture.md#プロトコル)。

[UDP](#udp)では、チェックサムによりエラーを検知すると[パケット](./network.md#パケット)全体が破棄される。UDP-Liteでは、チェックサムを計算する範囲を[アプリケーション](../../../computer/software/_/chapters/software.md#応用ソフトウェア)が決めることができる。
