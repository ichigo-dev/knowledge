# 『トランスポート層』ノート

（最終更新： 2023-03-03）


## 目次

1. [TCP](#tcp)
	1. [ストリーム](#ストリーム)
	1. [確認応答](#確認応答)
	1. [否定確認応答](#否定確認応答)
	1. [シーケンス番号](#シーケンス番号)
	1. [TCPのフレームフォーマット](#tcpのフレームフォーマット)
1. [UDP](#udp)
	1. [UDPのフレームフォーマット](#udpのフレームフォーマット)
1. [ソケット](#ソケット)
1. [スリーウェイハンドシェイク](#スリーウェイハンドシェイク)
1. [MSS](#mss)
1. [ウィンドウ](#ウィンドウ)
	1. [ウィンドウサイズ](#ウィンドウサイズ)
	1. [ウィンドウ制御](#ウィンドウ制御)
	1. [スライディングウィンドウ](#スライディングウィンドウ)
1. [フロー制御](#フロー制御)
	1. [ウィンドウプローブ](#ウィンドウプローブ)
1. [ふくそう制御](#ふくそう制御)
	1. [バースト](#バースト)
	1. [スロースタート](#スロースタート)
1. [Nagleアルゴリズム](#nagleアルゴリズム)
1. [シリーウィンドウシンドローム](#シリーウィンドウシンドローム)
	1. [遅延確認応答](#遅延確認応答)
1. [ピギーバック](#ピギーバック)
1. [QUIC](#quic)
1. [SCTP](#sctp)
	1. [マルチホーミング機能](#マルチホーミング機能)
1. [DCCP](#dccp)
1. [UDP-Lite](#udp-lite)


## TCP

**TCP**(Transmission Control Protocol)はコネクション型で、信頼性のあるストリーム型のプロトコル。ネットワークの途中でパケットが喪失した場合の再送制御や、順序が入れ替わった場合の順序制御などを行う。

- 信頼性が必要な通信
- インターネットを介して大量のデータを転送する場合
- ビデオオンデマンドやライブ配信といった、即時性がそれほど必要ない動画や音声の再生（ストリーミング）

### ストリーム

**ストリーム**は、切れ目のないデータ構造のこと。

### 確認応答

**確認応答**(**ACK**)は、TCPにおいて、送信したデータが受信ホストに到達したときに、受信ホストが送信ホストに対してデータが到達したことを知らせること。

### 否定確認応答

**否定確認応答**(**NACK**)は、TCPにおいて、送信したデータが受信ホストに正しく伝わらなかった時に、受信ホストが送信ホストに対してそのことを知らせること。

### シーケンス番号

**シーケンス番号**は、TCPで送信されるパケットにつけられる通し番号。受信ホストは、送信ホストの再送処理などにより、重複したデータを受け取る可能性がある。シーケンス番号は、このような重複したパケットを識別して破棄するためにも利用される。

### タイムアウト

**タイムアウト**は、ある一定の時間が経過しても、受信ホストから確認応答が返ってこないこと。タイムアウトが発生した場合、送信ホストはデータが喪失したと判断して再送処理を行う。確認応答の到着を待つ時間を**再送タイムアウト時間**という。再送タイムアウト時間を決めるため、パケットを送信する度に通信のラウンドトリップタイムとジッタを計算する。

### TCPのフレームフォーマット


## UDP

**UDP**(User Datagram Protocol)はコネクションレス型で、信頼性のないプロトコル。高速性やリアルタイム性を重視する通信や同報通信を行いたい場合に利用する。

- 総パケット数が少ない通信（DNS、SNMPなど）
- 動画や音声などのマルチメディア通信（即時性が必要な通信）
- LANなどの特定のネットワークに限定したアプリケーションの通信
- 同報性が必要な通信（ブロードキャスト、マルチキャスト）

### UDPのフレームフォーマット


## ソケット

**ソケット**は、TCPやUDPを利用して通信を行うために広く使われているAPI。アプリケーションはソケットを利用して、通信相手のIPアドレスやポート番号の設定、データの送受信の要求を行う。


## スリーウェイハンドシェイク

**スリーウェイハンドシェイク**は、TCPにおけるコネクション確立の方法で、合計で3回のパケットをやり取りする。


## MSS

**MSS**（Maximum Segment Size: **最大セグメント長**）は、TCPパケットにおけるペイロード（TCPヘッダは含まない）の最大長。MSSは、コネクション確立時に決定される。


## ウィンドウ

**ウィンドウ**は、TCPにおけるデータ転送をウィンドウ制御によって行うときの、データ転送の単位。複数のセグメントをひとつにまとめたもの。

### ウィンドウサイズ

**ウィンドウサイズ**は、ウィンドウの大きさ。

### ウィンドウ制御

**ウィンドウ制御**は、TCPにおいて効率よくパケットを伝送するための仕組み。複数のセグメントをまとめたウィンドウを送信することで、毎回確認応答を待たずに連続したデータを送信できる。

### スライディングウィンドウ

**スライディングウィンドウ**は、確認応答を受け取った分だけウィンドウをずらして、次々とデータを転送していく方法。ウィンドウ制御では複数のセグメントに対してまとめて確認応答をしているが、スライディングウィンドウでは全てのセグメントに対して確認応答が行われるため、信頼性を損なわない。


## フロー制御

**フロー制御**は、受信側の受信能力に合わせてパケット送信量を制御する方式。

受信ホストは、受信可能なバッファサイズをTCPヘッダのフィールドに入れて送信ホストに送る。このフィールドの値が大きいほどスループットが大きく、高い効率での通信が可能になる。

受信ホストはバッファがいっぱいになると、送信ホストに対してデータの送信停止を要求する。停止したデータのやり取りを再開するために、送信ホストはウィンドウプローブと呼ばれるセグメントを時々送信する。

### ウィンドウプローブ

**ウィンドウプローブ**は、一時停止したデータ送信を再開するため、受信ホストのバッファに空きがあるかを確認するセグメント。


## ふくそう制御

**ふくそう制御**は、ネットワークが混雑することを防ぐための制御。

### バースト

**バースト**は、連続的にパケットが送信されることによって、トラフィックが混雑し、ふくそう状態となること。

### スロースタート

**スロースタート**は、TCPの通信開始時は送信量を抑えておき、徐々に増やしていく方式。送信側でデータの送信量を調整するための**ふくそうウィンドウ**を定義しておき、最初はこのウィンドウの大きさを1セグメントに設定しておく。確認応答されるたびに1セグメントずつウィンドウを大きくしていき、タイムアウトが発生した際には、ふくそうウィンドウを1にして再度スロースタートをやり直す。


## Nagleアルゴリズム

**Nagleアルゴリズム**は、ネットワークの利用効率を高めるためにTCPで用いられているアルゴリズム。その瞬間に送信側に送信すべきデータがあったとしても、そのデータが少ない場合にはすぐに送信せずに遅延させる。通信が遅延してほしくないような場合には、このアルゴリズムを無効にする。


## シリーウィンドウシンドローム

**シリーウィンドウシンドローム**(SWS: Silly Window Syndrome)は、データを受信したホストが即座に確認応答をすることで、次々にデータを受信してしまい、バッファがいっぱいになる現象。

### 遅延確認応答

**遅延確認応答**は、シリーウィンドウシンドロームを防ぐため、確認応答のタイミングを遅延させる方法。


## ピギーバック

**ピギーバック**は、確認応答とレスポンスのデータパケットを1つのパケットとして送る方法。


## QUIC

**QUIC**(Quick UDP Internet Connection)は、Googleによって提案され、標準化が進められているプロトコル。TCPには暗号化の機能はないが、QUICはそれ自体で暗号化通信を可能にする。

QUICはUDPを使用するため、UDPとQUICを合わせてトランスポートプロトコルの役割を果たす。QUICの特徴は次の通り。

- 認証、暗号化
- 低遅延のコネクション管理
- 多重化（1コネクションで複数のストリームを同時に扱う）
- 高精度な再送処理
- コネクションのマイグレーション（IPアドレスが変わってもコネクションを維持する）

TCPではコネクションの確立だけで3回、TLSによる通信の暗号化を行う場合は7回のパケットのやり取りが必要であったが、QUICでは1回のパケットのやり取りで実現できる。


## SCTP

**SCTP**(Stream Control Transmission Protocol)はTCPと同様、データの到達に関する信頼性を提供するプロトコル。マルチホーミング機能をサポートしている。

### マルチホーミング機能

**マルチホーミング機能**は、複数のNICがついているホストで、NICが変わっても通信が継続できる機能。


## DCCP

**DCCP**(Datagram Congestion Control Protocol)は、UDPを補うプロトコルで、データの到達性に関する信頼性はないものの、コネクション型でコネクションの確立と切断に関する信頼性を持つ。


## UDP-Lite

**UDP-Lite**(Lightweight UDP)は、UDPとほぼ同じ機能を提供するプロトコル。

UDPでは、チェックサムによりエラーを検知するとパケット全体が破棄される。UDP-Liteでは、チェックサムを計算する範囲をアプリケーションが決めることができる。
