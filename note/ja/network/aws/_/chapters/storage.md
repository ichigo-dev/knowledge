# 『ストレージ』ノート

（最終更新： 2023-03-03）


## 目次

1. [EBS](#ebs)
	1. [ボリュームタイプ](#ボリュームタイプ)
	1. [バースト性能](#バースト性能)
	1. [EBSマルチアタッチ](#ebsマルチアタッチ)
1. [EFS](#efs)
	1. [パフォーマンスモード](#パフォーマンスモード)
	1. [スループットモード](#スループットモード)
1. [S3](#s3)
	1. [バケット](#バケット)
	1. [オブジェクト](#オブジェクト)
	1. [メタデータ](#メタデータ)
	1. [ストレージクラス](#ストレージクラス)
	1. [静的コンテンツホスティング機能](#静的コンテンツホスティング機能)
	1. [署名付きURL](#署名付きurl)
	1. [署名付きURL](#署名付きurl)
1. [S3 Glacier](#s3-glacier)
	1. [ボールト](#ボールト)
	1. [アーカイブ](#アーカイブ)
	1. [インベントリ](#インベントリ)
	1. [ジョブ](#ジョブ)
	1. [S3 Glacier Select](#s3-glacier-select)
	1. [ボールトロック](#ボールとロック)
1. [Storage Gateway](#storage-gateway)
	1. [ファイルゲートウェイ](#ファイルゲートウェイ)
	1. [ボリュームゲートウェイ](#ボリュームゲートウェイ)
	1. [テープゲートウェイ](#テープゲートウェイ)
1. [FSx](#fsx)
	1. [FSx for windowsファイルサーバ](#fsx-for-windowsファイルサーバ)
	1. [FSx for Lustre](#fsx-for-lustre)


## EBS

**EBS**(**Amazon Elastic Block Store**)は、AWSが提供するブロックストレージサービスである。EC2のOS領域として利用したり、追加ボリュームとして複数のEBSをEC2にアタッチすることもできる。RDSのデータ保存用にも用いられる。

EBSはEC2と1対1で対応するサービスである。複数のEC2にアタッチするマルチアタッチ機能もあるが制約が多い。また、EBSは同じAZ内にあるEC2にしかアタッチすることはできず、別のAZのEC2にアタッチしたい場合は、EBSのスナップショットを取得して新しいEBSボリュームをEC2と同じAZ内に作る必要がある。

### ボリュームタイプ

SSDとHDDそれぞれにボリュームタイプの種類があり、それに加えて旧世代のHDDストレージタイプとしてマグネティックタイプがある。各タイプの性能を最大限発揮するためには、EBS最適化インスタンスオプションのついたEC2を利用することが推奨される。

- **汎用SSD**(gp2、gp3) : EBSの中で最も一般的なボリュームタイプ。性能の指標としてIOPS（1秒あたりに処理できるI/Oアクセス数）を用い、容量に応じたベースライン性能がある。容量が少ないボリュームには、一時的なIOPSの上昇に対応できるようにバースト機能が用意されている。
- **プロビジョンドIOPS SSD**(io1) : EBSの中で最も高性能なボリュームタイプ。RDSやEC2インスタンスでデータベースサーバを構成する場合など、高いIOPS性能が求められる場合や、高いスループットが必要なユースケースに適している。
- **スループット最適化HDD**(st1) : HDDをベースとしたスループット重視のボリュームタイプ。ログデータに対する処理やバッチ処理のインプット用ファイルなど、大容量ファイルを高速に読み取るようなユースケースに適している。性能指標としてスループットを用いている。
- **Cold HDD**(sc1) : 性能は高くはないが最も低コストなボリュームタイプ。利用頻度が少なく、アクセス時の性能も求められないデータにシーケンシャルアクセス（端から順番にアクセスする、⇔ ランダムアクセス）するようなユースケース、あるいはアーカイブ領域の用途に適している。

### バースト性能

**バースト性能**は、ストレージサービスの指標のひとつで、一時的な処理量の増加へどれほど対応できるかを表している。あくまでベースライン性能を中心に設計しておき、バースト性能に頼ったシステムとならないようにする。

### EBSマルチアタッチ

**EBSマルチアタッチ**は、複数のEC2インスタンスに同一のEBSをアタッチできるという機能。同一のAZのインスタンスからのみアタッチ可能で、書き込みの排他制御を利用者自身で検討する必要がある。


## EFS

**EFS**(**Amazon Elastic File System**)は、容量無制限で複数のEC2インスタンスから同時にアクセスできるファイルストレージサービス。クライアントからEFSへの接続は、一般的な**NFS**(Network File System)プロトコルをサポートしている。**amazon-efs-utils**ツールを使うと、EFSへのマウントに関する推奨オプションが含まれていたり、ファイルシステムにトラブルが発生した場合のトラブルシューティングに役立つログが記録できたりする。EFSはファイルが作成されると3か所以上のAZに保存される分散ファイルシステムを構成する。

### パフォーマンスモード

EFSには、**汎用パフォーマンスモード**と**最大I/Oパフォーマンスモード**がある。通常は汎用パフォーマンスモード、数百～数千台といったクライアントから同時にEFSにアクセスするようなユースケースでは最大I/Oパフォーマンスモードを用いる。

どちらのモードを用いるかの指標として、CloudWatchの**PercentIOLimit**というメトリクスが参考になる。汎用パフォーマンスモードでPercentIOLimitが長時間高い状態であれば、最大I/Oパフォーマンスモードに変更することを検討するとよい。

パフォーマンスモードは後から変更できないので注意する。

### スループットモード

EFSには、**バーストスループットモード**と**プロビジョニングスループットモード**がある。

バーストスループットモードは、EFSに保存されているデータ容量に応じてベースラインとなるスループットが設定されている。一時的なスループットの上昇にも耐えられるようなバースト機能を持ったモードとなっている。

プロビジョニングスループットモードは、バーストスループットモードで設定されているベースラインスループットやバースト時の最大スループットでは性能が足りない場合に、任意のスループット値を指定することができるモード。Web配信コンテンツやアプリケーションデータなどの頻繁なアクセスが見込まれる場合に有用。

どちらのモードを用いるかの指標として、CloudWatchの**BurstCreditBalance**というメトリクスが参考になる。クレジットバランスをすべて使い切ってしまったり、常に減少傾向である場合にはプロビジョニングスループットモードを選択する。

スループットモードはあとから変更できる。


## S3

**S3**(**Amazon Simple Storage Service**)は、高い耐久性を持つ容量無制限のオブジェクトストレージサービス。S3の各オブジェクトには、RESTやSOAPといったHTTPベースのWeb APIを使ってアクセスする。柔軟性に優れており、アイデア次第で様々な利用方法がある。

- データバックアップ
- ビックデータ解析用のデータレイク
- ETL（Extract/Transform/Load）の中間ファイル保存
- Auto Scaling構成されたEC2インスタンスやコンテナからのログ転送先
- 静的コンテンツのホスティング
- Key-Value型のデータベース

### バケット

**バケット**は、S3においてオブジェクトを保存するための領域。バケット名はAWS内で一意である必要がある。

### オブジェクト

**オブジェクト**は、S3において保存されるデータそのもの。各オブジェクトにはキーが付与され、「バケット名+キー名+バージョンID」で必ず一意になるURLが作成される。

### メタデータ

**メタデータ**は、S3においてオブジェクトを管理するための情報。アプリケーションで必要な情報をユーザ定義メタデータとして保持することもできる。

### ストレージクラス

S3には用途に応じてランク分けされたストレージクラスがある。可用性の性能にはSLA(Service Level Agreement)が用いられている。

- **S3標準** : デフォルトのストレージクラス。
	- 耐久性： 99.999999999%（イレブンナイン）
	- 可用性： 99.99%
- **S3標準 - 低頻度アクセス** : 格納コストが安価なストレージクラス。データの読み出し容量に対する従量課金が行われる。
	- 耐久性： 99.999999999%（イレブンナイン）
	- 可用性： 99.9%
- **S3 1ゾーン - IA** : 単一のAZ内のみでデータを複製するストレージクラス。
	- 耐久性： 99.999999999%（イレブンナイン）
	- 可用性： 99.5%
- **S3 Intelligent - Tiering** : 参照頻度の高低を明確に決めることができないデータを扱う場合に有効なストレージクラス。S3標準とS3標準 - 低頻度アクセスの2層構成となっている。
	- 耐久性： 99.999999999%（イレブンナイン）
	- 可用性： 99.9%
- **S3 Glacier** : ほとんど参照されないアーカイブ目的のデータを保存するストレージクラス。新規作成時に選択することはできず、ライフサイクル管理機能によって利用可能となる。データへのアクセスには事前にリクエストが必要で、アクセスできるようになるまで時間がかかる。
	- 耐久性： 99.999999999%（イレブンナイン）
	- 可用性： 99.99%
- **S3 Glacier Deep Archive** : S3 Glacier同様アーカイブ用のストレージクラス。さらにアクセス頻度が低いデータを想定している。
	- 耐久性： 99.999999999%（イレブンナイン）
	- 可用性： 99.99%


### 静的コンテンツホスティング機能

**静的コンテンツホスティング機能**は、S3をCDNとして静的なコンテンツの配信を行う機能。

### 署名付きURL

**署名付きURL**は、アクセスを許可したいオブジェクトに対して期限を指定してURLを発行する機能。バケットやオブジェクトのアクセス制御を変更することなく特定のオブジェクトに一時的にアクセスを許可したい場合に有効。署名付きURLを知っている人はだれでもオブジェクトにアクセスできる。


## S3 Glacier

**Amazon S3 Glacier**は、S3と同様にイレブンナインの耐久性を持ちながらもコストを抑えた、アーカイブストレージサービス。データの取り出しには時間がかかるため、アクセス頻度が低いデータなど限られたユースケースにのみ使用可能。

### ボールト

**ボールト**は、S3 Glacierにおいてアーカイブを保存するための領域で、S3のバケットに相当する。

### アーカイブ

**アーカイブ**は、S3 Glacierに格納されるデータのこと。

### インベントリ

**インベントリ**は、各ボールトに保存されているアーカイブの情報を収集し、1日1回の頻度で更新される。リアルタイムで状況を確認したい場合は、マネジメントコンソールで確認するか、ListVaults APIを実行する。

### ジョブ

**ジョブ**は、アーカイブやインベントリに対して検索をかけたり、データをダウンロードするといった要求に対して処理を実行し、処理の状況を管理する機能。

### S3 Glacier Select

**S3 Glacier Select**は、アーカイブデータに対してSQLを実行して、条件に合ったデータを抽出する機能。

### ボールトロック

**ボールトロック**は、S3 Glacierのアーカイブが削除されないように制御する機能。ボールトロックポリシーを設定することで、ユーザのアーカイブ削除を拒否する。


## Storage Gateway

**AWS Storage Gateway**は、オンプレミスにあるデータをクラウドへ連携するための受け口を提供するためのサービス。データの保存先としてはS3やS3 Glacierなどの耐久性が高く低コストなストレージが利用されることが多い。

### ファイルゲートウェイ

**ファイルゲートウェイ**は、S3をクライアントサーバからNFSマウントして、ファイルシステムのように扱うことができるゲートウェイ。作成したファイルは、非同期（ほぼリアルタイム）でS3にアップロードされる。

### ボリュームゲートウェイ

**ボリュームゲートウェイ**は、各ファイルをオブジェクトとして管理するのではなく、S3のデータ保存領域全体を1つのボリュームとして管理する。クライアントサーバからのゲートウェイへの接続方式は、iSCSI接続になる。

- **キャッシュ型ボリューム** : 頻繁に利用するデータはStorage Gateway内のキャッシュディスク（オンプレミス）に保存して、すべてのデータを保存するストレージ（プライマリストレージ）としてS3を利用する。オンプレミスのキャッシュボリュームに頻繁に使用するデータを、アップロードバッファボリュームにS3にアップロードするデータを保管しておく。
- **保管型ボリューム** : すべてのデータを保存するストレージとしてローカルストレージを利用し、データを定期的にスナップショット形式でS3へ転送する。オンプレミスのデータを定期的にバックアップする用途に適している。

### テープゲートウェイ

**テープゲートウェイ**は、テープデバイスの代替としてS3やS3 Glacierにデータをバックアップするタイプのゲートウェイ。すでにバックアップにテープデバイスを利用している場合は、Storage Gatewayへの移行が可能。


## FSx

**Amazon FSx**は、フルマネージドなファイルストレージで、Windows向けのAmazon FSx for Windowsファイルサーバと、ハイパフォーマンスコンピューティング向けのAmazon FSx for Lustreがある。

### FSx for Windowsファイルサーバ

**FSx for Windowsファイルサーバ**は、Windows用のフルマネージドなファイルサーバ。Windowsで利用できるユーザクォータ、エンドユーザファイルの復元、Microsoft Active Directory統合などの幅広い機能が利用可能。単一のサブネットにエンドポイントとなるENIを配置し、SMBプロトコルを介してアクセス可能。

### FSx for Lustre

**FSx for Lustre**は、フルマネージドな分散ファイルシステムで、作成時にS3のバケットと関連付けされる。S3上のファイルをインデックスし、あたかも自前のファイルのように見せる。高速なデータアクセスが必要なハイパフォーマンスコンピューティングで利用され、機械学習やビッグデータ処理に使われる。
