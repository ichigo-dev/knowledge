# 『コンピューティング』

（最終更新： 2023-02-18）


## 目次

1. [EC2](#ec2)
	1. [AMI](#ami)
	1. [インスタンスタイプ](#インスタンスタイプ)
	1. [インスタンスファミリー](#インスタンスファミリー)
	1. [スポットインスタンス](#スポットインスタンス)
	1. [リザーブドインスタンス](#リザーブドインスタンス)
	1. [EBS最適化オプション](#ebs最適化オプション)
1. [Auto Scaling](#auto-scaling)
	1. [スケーリングポリシー](#スケーリングポリシー)
	1. [猶予期間](#猶予期間)
	1. [ウォームアップ](#ウォームアップ)
	1. [クールダウン](#クールダウン)
	1. [ライフサイクルフック](#ライフサイクルフック)
	1. [終了ポリシー](#終了ポリシー)
1. [ECS](#ecs)
1. [Lambda](#lambda)
1. [Elastic Beanstalk](#elastic-beanstalk)


## EC2

**EC2**(**Amazon Elastic Compute Cloud**)は、仮想サーバを提供するコンピューティングサービス。AMIを元にして容易に新しいコンピュータを構築することができ、**インスタンス**という単位でサーバが管理される。インスタンスには起動中(**Running**)、停止中(**Stopped**)、削除済み(**Terminated**)の3つの状態がある。

EC2は**従量課金型**のサービスで、インスタンスタイプやリージョンと、インスタンスがRunning状態だった時間でコストが決まる。

### AMI

**AMI**(**Amazon Machine Image**)は、EC2インスタンスの構築に必要な情報を集めたテンプレート。

### インスタンスタイプ

**インスタンスタイプ**は、EC2インスタンスの性能を決定するもので、様々なユースケースに対応したCPUやメモリ、ストレージ、ネットワークキャパシティの組み合わせが用意されている。

インスタンスが何に最適化されているかを表すインスタンスファミリー、そのインスタンスの**世代**、 `medium` や `xlarge` といった**インスタンスサイズ**の組み合わせで表現される。

### インスタンスファミリー

**インスタンスファミリー**は、そのインスタンスが何に最適化されたインスタンスであるかという分類を表し、インスタンスタイプの先頭に付与される。

| 種類                     | 特徴                                     | ファミリー       |
|--------------------------|------------------------------------------|------------------|
| 汎用                     | バランスの取れた汎用タイプで、比較的安価 | `T/M/A/Mac`      |
| コンピューティング最適化 | 高い計算能力                             | `C`              |
| メモリ最適化             | メモリを多く搭載                         | `R/X/z`          |
| 高速コンピューティング   | グラフィック演算や推論処理などに最適化   | `P/DL/G/F/V/Inf` |
| ストレージ最適化         | I/Oパフォーマンスが高く、大容量          | `I/D/H`          |

### スポットインスタンス

**スポットインスタンス**は、AWSが余らせているEC2リソースを入札形式で安く利用する形式。ただし、他の利用者からの利用リクエストが増えて余剰なリソースがなくなってしまうと、自動的にインスタンスが中断される。開発用や学習用に相性のよいオプションといえる。

### リザーブドインスタンス

**リザーブドインスタンス**は、長期間利用することを約束することで割引を受けられるオプション。インスタンスタイプを固定してしまうことになるので、サービスのリリース後、安定してきてから購入することを検討するのがよい。

### EBS最適化オプション

**EBS最適化オプション**は、通常のネットワーク帯域とは別に、EBS用の帯域を確保するEC2インスタンスのオプション。EBSはAWSのディスク機能であり、ディスクIOが頻繁なシステムではこのオプションを有効にすることで帯域が足りなくなることを防げる。


## Auto Scaling

**Auto Scaling**は、システムの利用状況に応じて自動的にELBに紐づくインスタンスの台数を増減させる（スケールアウト/スケールイン）機能。インスタンスの最小・最大台数を設定しておき、障害発生などによってインスタンスがヘルスチェックに失敗した場合に、自動的にインスタンス数をキープする。

### スケーリングポリシー

スケーリングには、動的なスケーリング、予測スケーリング、スケジュールスケーリングがある。動的なスケーリングには、次のような種類のスケーリングポリシーがある。

- **簡易スケーリング** : 「CPU使用率が70%を超えたらスケールアウトする」といったように、1つのメトリクスに対して1つの閾値を設定してスケーリングを行う。
- **ステップスケーリング** : 1つのメトリクスに対して複数の閾値を設定することで、段階的にスケーリングの設定ができる。
- **ターゲット追跡スケーリング** : 1つのメトリクスに目標値を設定しておき、そのメトリクスを維持できるように動的にスケーリングする。

### 猶予期間

**猶予期間**は、スケールアップ中にヘルスチェックを停止する機能。猶予期間はAuto Scalingにおいて、スケールアウトによる新しいインスタンスの起動中に、別の新たなインスタンスが起動されてしまうことを防ぐための仕組みである。

### ウォームアップ

**ウォームアップ**は、新しいインスタンスがサービスを開始してからトラフィックを受信できるまでの期間を設定しておき、その期間中に別のスケーリングポリシーが適用される場合は2つのポリシーの差分のみが起動されるようにする機能。

ステップスケーリングにおいて、1つ目のスケーリングポリシーによってインスタンスが起動している途中で2つ目のスケーリングポリシーによって更にインスタンスが追加されるということが考えられる。例えば、1つ目のスケーリングポリシーでインスタンスが1台、2つ目のスケーリングポリシーでインスタンスが4台増える設定の場合、これらのポリシーが連続で適用された場合には5台のインスタンスが起動される。しかし、最新の負荷状況を考えると、2つ目のポリシーのみを適用して4台のインスタンスを起動したい。これを防ぐために、ウォームアップの機能を利用する。

### クールダウン

**クールダウン**は、起動指示直後に待ち時間を設けることで、複数のアラートがきても次々にインスタンスが立ち上がることを防ぐ機能。

Auto Scalingにより新しいインスタンスが起動された直後、ブートストラップなどの処理によって準備が整うまでに数分かかる場合があり、準備が整うまでの間に新しいアラートがくると連鎖的に複数のインスタンスが起動されてしまう。これを防ぐために、クールダウンの機能を利用する。

### ライフサイクルフック

**ライフサイクルフック**は、Auto Scalingによるインスタンスの起動・削除時に、インスタンスを一時停止してカスタムアクションを実行する機能。インスタンスの削除時のログやデータの退避などに利用される。

### 終了ポリシー

**終了ポリシー**は、負荷が下がったときにインスタンスを減らす（スケールイン）設定。


## ECS

**ECS**(**Amazon Elastic Container Service**)は、Dockerコンテナ環境を提供するサービス。EC2にDockerソフトウェアの導入作業や継続したメンテナンス作業などを加えたもので、その管理をAWSがサポートしてくれる。

EC2インスタンス上で実行されるコンテナのことを**Task**と呼び、EC2インスタンスのことを**Cluster**と呼ぶ。1つのCluster上では複数のTaskを実行することができる。Cluster上で動作するTaskの定義は**Task Definition**で行う。**Service**は1つ以上の同じTaskをまとめたもので、ELBによって負荷分散をする際には、EC2の代わりにServiceを指定する。

また、セキュリティ面では、TaskごとにIAMロールを割り当てられるという特徴がある。EC2ではインスタンス単位でしか設定できない。


## Lambda

**AWS Lambda**は、サーバをプロビジョニングしなくてもプログラムを実行できるコンピューティングサービスで、サーバレスアーキテクチャの中核を担う。利用者はソースコードだけを用意すればすぐにプログラムが実行できる。LambdaはNode.jsやPython、Java、Ruby、C#、Go、Powershellといった多数の言語に対応している。

Lambdaは**Lambda関数**という単位で、実行するプログラムとその実行トリガーとなるイベントを事前に定義する。Lambda関数を実行することを、**キック**という。


## Elastic Beanstalk

**Elastic Beanstalk**は、一般的なアプリケーションのインフラストラクチャに必要なAWS機能を自動的に構成して提供するサービス。アプリケーションの運用に必要な環境の作成からデプロイを容易に行えるため、ネットワークやインフラの知識に乏しい開発チームでも利用しやすい。
