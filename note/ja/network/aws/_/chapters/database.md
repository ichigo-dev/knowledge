# 『データベース』

（最終更新： 2023-02-18）


## 目次

1. [RDS](#rds)
	1. [Aurora](#aurora)
	1. [リードレプリカ](#リードレプリカ)
	1. [バックアップとリストア](#バックアップとリストア)
	1. [RDSのセキュリティ](#rdsのセキュリティ)
	1. [マルチAZ構成](#マルチaz構成)
1. [DynamoDB](#dynamodb)
	1. [高可用性設計](#高可用性設計)
	1. [スループットキャパシティ](#スループットキャパシティ)
	1. [データパーティショニング](#データパーティショニング)
	1. [DynamoDB Streams](#dynamodb-streams)
	1. [Consistent Read](#consistent-read)
	1. [DynamoDB Accelerator](#dynamodb-accelerator)
1. [ElastiCache](#elasticache)
	1. [Memcached](#memcached)
	1. [Redis](#redis)
1. [Redshift](#redshift)
	1. [Redshift Spectrum](#redshift-spectrum)


## RDS

**RDS**(**Amazon Relational Database Service**)は、AWSが提供するマネージドRDBサービスである。データベースエンジンは、AuroraやMySQL、MariaDB、PostgreSQL、Oracle、Microsoft SQL Serverなどから選択できる。RDSのデータ保存用ストレージには、EBSを利用する。ボリュームタイプとして、汎用SSD、プロビジョンドIOPS SSD、マグネティックから選択することができる。

### Aurora

**Amazon Aurora**は、AWSが開発したデータベースエンジンで、RDSの利用時に選択することができる。DBインスタンスを作成すると同時にDBクラスタが作成される。DBクラスタは、1つ以上のDBインスタンスと、各DBインスタンスから参照するデータストレージ（クラスタボリューム）で構成される。クラスタボリュームは単一のリージョン内の3つのAZにそれぞれ2つのデータコピーで構成され、各ストレージ間のデータは自動的に同期される。

**Auroraレプリカ**は通常のリードレプリカと違い、Auroraのプライマリインスタンスに障害が発生した場合にレプリカインスタンスがプライマリインスタンスに昇格することでフェイルオーバを実現する。

### リードレプリカ

**リードレプリカ**は、通常のRDSとは別に参照専用のDBインスタンスを作成することができるサービス。マスタDBの負荷を抑えたり、読み込みが多いアプリケーションではDBリソースのスケールアウトを容易に実現することが可能となる。

マスタとリードレプリカのデータ同期は**非同期レプリケーション方式**であるため、参照されるタイミングによってはマスタ側で更新された情報が反映されていない可能性があることに注意。

### バックアップとリストア

**自動バックアップ**は、バックアップウィンドウと保持期間を指定することで、1日1回自動的にバックアップ（DBスナップショット）を取得してくれるサービス。

**手動スナップショット**は、任意のタイミングでRDBのバックアップを取得できるサービス。

データの**リストア**は、スナップショットから新規のRDSを作成することで簡単に実現できる。

**ポイントインタイムリカバリ**は、自動バックアップのスナップショットを利用して、任意のタイミングの状態のRDSを新規に作成することができるサービス。

### RDSのセキュリティ

RDSはVPCに対応しているため、インターネットに接続せずともVPC内のサービスから利用できる。セキュリティグループによる通信要件の制限も可能で、EC2やほかのAWSサービスからRDSまでの通信もデータベースエンジンが提供するSSLを使った暗号化に対応している。

また、RDSの**暗号化オプション**を有効にすることで、データが保存されるストレージやスナップショット、ログなどのRDSに関連するすべてのデータが暗号化された状態で保持される。

### マルチAZ構成

マルチAZ構成は、1つのリージョン内の2つのAZにDBインスタンスをそれぞれ配置し、障害発生時やメンテナンス時のダウンタイムを短くすることで高可用性を実現する構成のこと（RDSに限らず、異なるAZにインスタンスを用意することで単一障害点をつくらないようにする）。

ただし、2つのAZ間でデータを同期するため、シングルAZ構成よりも書き込みやコミットにかかる時間が長くなる。また、フェイルオーバが発生した場合に、RDSへの接続用のFQDNのDNSレコードをスタンバイ側のIPアドレスに書き換える必要があり、この操作に時間がかかる点にも注意が必要である。


## DynamoDB

**Amazon DynamoDB**は、AWSが提供するKey-Value型のマネージドNoSQLデータベースサービス。テーブルやインデックスを作成する際に、読み取り・書き込みに必要なスループットを指定してリソースを確保することで、安定した性能を担保する仕組み。トランザクション機能にも対応している。

以下のようなシステムに適している。

- 高い信頼性と拡張性を必要とするシステム
- スループットが増減するようなピーク帯のあるシステム
- 大量のデータを蓄積して高速な検索が可能なシステム
- 広告やゲームなどのユーザの行動履歴を管理するシステム
- Webアプリケーションの永続的セッションデータベース

### 高可用性設計

DynamoDBはデータが自動的に3つのAZに保存される仕組みになっており、単一障害点を持たない構成であるため、非常に可用性が高いサービスである。

### スループットキャパシティ

**Read Capacity Unit**(**RCU**)は、読み取りのスループットキャパシティを指定する指標。1RCUは、最大4KBの項目に対して、1秒当たり1回の強力な整合性のある読み取り性能、あるいは1秒当たり2回の結果的に整合性のある読み取り性能を担保することを示す。

**Write Capacity Unit**(**WCU**)は、書き込みのスループットキャパシティを指定する指標。1WCUは、最大1KBの項目に対して、1秒当たり1回の書き込み性能を担保することを示す。

DynamoDBでは、負荷の状況に応じてスループットキャパシティを自動的に増減することができる。急激なスループットの上昇に即座に対応できるわけではないため、事前にスパイクが発生することがわかっている場合は手動でキャパシティを拡張して対応する。

### データパーティショニング

DynamoDBはデータを**パーティション**という単位で分散保存する。1つのパーティションに保存できる容量やスループットキャパシティが決まっているため、データの増加や指定したスループットのサイズによって最適化された状態を保つように自動的にパーティションを拡張する。

### DynamoDB Streams

**DynamoDB Streams**は、DynamoDBに対して行われた直近24時間の追加・更新・削除の変更履歴を保持する機能。

### Consistent Read

**Consistent Read**は、DynamoDBのオプションで、有効にすると参照のリクエストがあった時点よりも前に書き込まれているデータがすべて反映された状態のデータをもとに参照結果を返す。RCUが2倍消費される点には注意が必要。

### DynamoDB Accelerator

**DynamoDB Accelerator**(**DAX**)は、DynamoDBの前段にキャッシュクラスタを構成する拡張サービス。


## ElastiCache

**Amazon ElastiCache**は、AWSが提供するインメモリ型データベースサービス。高頻度で参照するデータや検索に時間がかかるデータセットをメモリ上に保持することでパフォーマンスを向上させる。

### Memcached

**Memcached**は、KVS（Key-Valueストア）型インメモリデータベースのデファクトスタンダードとして広く利用されているエンジン。データの永続性機能はないため、メンテナンスや障害による再起動時にすべてのデータが消去される。

### Redis

**Redis**は、KVS型インメモリデータベースで、Memcachedよりも多くのデータが扱え、キャッシュ用としてだけではなくメッセージブローカーやキューを構成する要素としても利用される。ノード間のレプリケーション機能やデータ永続性機能といった可用性も考慮された機能が実装されている。


## Redshift

**Amazon Redshift**は、AWSが提供するデータウェアハウス（データの分析に最適化されたソフトウェア）向けのデータベースサービス。大量のデータから意思決定に役立つ情報を見つけ出すために必要な環境を安価で準備できる。

Redshiftは、複数ノードによる分散並列実行が大きな特徴として挙げられる。1つのRedshiftを構成する複数のノードのまとまりをRedshiftクラスタと呼び、クラスタは1つのリーダノードと複数のコンピュートノードから構成される。いかにコンピュートノードをまたがずに処理を完結させることができるのかがRedshift利用のポイントとなる。

**リーダノード**では、SQLクライアントやBI(Business Intelligence)ツールからの実行クエリを受け付けて、クエリの解析や実行プランの作成を行う。

**コンピュートノード**では、リーダノードからの実行クエリを処理する。各コンピュートノードはストレージとセットになっている。

**ノードスライス**は、Redshiftが分散並列処理をする最小の単位で、コンピュートノードの中でさらにリソースを分割してスライスという単位を構成する。

### Redshift Spectrum

**Redshift Spectrum**は、S3に置かれたデータを外部テーブルとして定義できるようにし、Redshift内にデータを取り込むことなくクエリの実行を可能にする拡張サービス。
