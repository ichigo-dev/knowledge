# HTTP


## 目次

1. [HTTPの基本](#httpの基本)
	1. [HTTPの役割](#httpの役割)
	1. [HTTPのバージョン](#httpのバージョン)
	1. [クライアントとサーバ](#クライアントとサーバ)
	1. [HTTPメッセージ](#httpメッセージ)
	1. [HTTPのステートレス性](#httpのステートレス性)
1. [HTTPメソッド](#httpメソッド)
	1. [HTTPの8つのメソッド](#httpの8つのメソッド)
	1. [HTTPメソッドとCRUD](#httpメソッドとcrud)
	1. [GET](#get)
	1. [POST](#post)
	1. [PUT](#put)
	1. [べき等と安全性](#べき等と安全性)
1. [ステータスコード](#ステータスコード)
	1. [ステータスコードの分類](#ステータスコードの分類)
	1. [頻出のステータスコード](#頻出のステータスコード)
1. [HTTPヘッダ](#httpヘッダ)


## HTTPの基本

### HTTPの役割

**HTTP**（HyperText Transfer Protocol）はハイパーテキストの転送用[プロトコル](/note/internet/chapters/01_basic_knowledge_of_network.ja.md#プロトコル)である。実際には、[HTML](./06_hypermedia_format.ja.md#html)や[XML](./06_hypermedia_format.ja.md#html)などのハイパーテキストだけではなく、静止画、音声、動画、JavaScriptプログラム、PDFなどコンピュータで扱えるデータであれば何でも転送できる。

### HTTPのバージョン

Berners-Leeが1990年にWebを発明したときに使っていた[プロトコル](/note/internet/chapters/01_basic_knowledge_of_network.ja.md#プロトコル)のことを**HTTP0.9**と呼ぶ。HTTP0.9には[HTTPヘッダ](#httpヘッダ)がなく、[HTTPメソッド](#httpメソッド)も[GET](#get)のみであった。

**HTTP1.0**は、[IETF](/note/internet/chapters/03_standarization_of_tcpip.ja.md#isoとietf)で標準化が行われた最初のバージョンである。HTTP1.0の最初の[ドラフト](/note/internet/chapters/03_standarization_of_tcpip.ja.md#標準化の流れ)は1993年に公開され、3年後の1996年に最終バージョンが公開された。この時期はNetscape NavigatorやInternet Explorerのブラウザ戦争が最も激化していたため、仕様と実装の乖離が生じてしまった。HTTP1.0では、ヘッダの導入、[GET](#get)以外のメソッドの追加などが行われた。

**HTTP1.1**は1997年に策定されて、1999年から2015年まで利用されていた。HTTP1.1では、チャンク転送、[Accept](#httpヘッダ)ヘッダによるコンテントネゴシエーション、複雑なキャッシュコントロール、持続的接続などの機能を追加している。また、**パイプライン**という前の[リクエスト](#クライアントとサーバ)の転送が完了する前に次の[リクエスト](#クライアントとサーバ)を転送できる機能や、**バーチャルホスト**という1つのWeb[サーバ](#クライアントとサーバ)で別々の異なる[ドメイン](/note/internet/chapters/07_internet_layer.ja.md#dnsの役割)のホームページが公開できる仕組みが搭載された。

**HTTP2.0**は2015年に公開された。複数の[リクエスト](#クライアントとサーバ)を同時に処理可能になり、ヘッダの圧縮やサーバプッシュ、転送するコンテンツの優先度設定などの複数の機能追加が行われた。

**HTTP3.0**は2018年に公開された。[TCP](/note/internet/chapters/08_transport_layer.ja.md#tcp)ではなく、[UDP](/note/internet/chapters/08_transport_layer.ja.md#udp)と**QUIC**という[プロトコル](/note/internet/chapters/01_basic_knowledge_of_network.ja.md#プロトコル)上で動作するアプリケーション[プロトコル](/note/internet/chapters/01_basic_knowledge_of_network.ja.md#プロトコル)である。HTTP3.0では、暗号化通信が[プロトコル](/note/internet/chapters/01_basic_knowledge_of_network.ja.md#プロトコル)自体に組み込まれ、[スリーウェイハンドシェイク](/note/internet/chapters/08_transport_layer.ja.md#コネクション管理)の必要がないため接続が高速であるなどの特徴がある。

### クライアントとサーバ

Webはクライアント/サーバシステムであり、**クライアント**（Webブラウザ）が**サーバ**（Webサーバ）に対して**リクエスト**を送信し、**レスポンス**を受け取る。このような[プロトコル](/note/internet/chapters/01_basic_knowledge_of_network.ja.md#プロトコル)を、**リクエスト/レスポンス型のプロトコル**という。

また、[HTTP](#httpの基本)は**同期型**（Synchronous）の[プロトコル](/note/internet/chapters/01_basic_knowledge_of_network.ja.md#プロトコル)であるため、サーバでの処理に時間がかかる場合でも、クライアントはレスポンスが返るまで待機する。

リクエストを送信する目的でサーバとのコネクションを確立するプログラムをクライアント、サーバに対して具体的にリクエストを発行するものを**ユーザエージェント**と区別する場合もある。

### HTTPメッセージ

[リクエスト](#クライアントとサーバ)と[レスポンス](#クライアントとサーバ)の際にやり取りされるメッセージをそれぞれ**リクエストメッセージ**、**レスポンスメッセージ**といい、これらを合わせて**HTTPメッセージ**という。

```
[リクエストメッセージ]
GET /test?q=test HTTP/1.1
Host: example.jp
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)
Accept: text/html,application/xhtml+xml,application/xml;q=0.9
```

リクエストメッセージの1行目を**リクエストライン**といい、**HTTPメソッド**、**リクエストURL**、**プロトコルバージョン**からなる。

リクエストメッセージの2行目以降は、メッセージのメタデータである**ヘッダ**が続く。

ヘッダの後には**ボディ**が続く場合もある。

```
[レスポンスメッセージ]
HTTP/1.1 200 OK
Content-Type: application/xhtml+xml; charset=utf-8

<html>
 ...
</html>
```

レスポンスメッセージの1行目を**ステータスライン**といい、**プロトコルバージョン**、**ステータスコード**、**テキストフレーズ**からなる。

レスポンスメッセージの2行目以降は、リクエストメッセージ同様、**ヘッダ**が続く。Content-Typeで**MIME（Multipurpose Internet Mail Extensions）メディアタイプ**や文字エンコーディング方式を指定している。

ヘッダとボディは空行で区切られており、ボディにはHTMLなどのコンテンツが含まれる。

---

HTTPメッセージの1行目は**スタートライン**と総称する。HTTPメッセージのボディには、テキストだけではなくバイナリデータも含めることができる。

### HTTPのステートレス性

**ステートレス**とは、[サーバ](#クライアントとサーバ)が[クライアント](#クライアントとサーバ)の**アプリケーション状態**を保存しない制約のことである。ステートレスなやりとりでは、[クライアント](#クライアントとサーバ)は毎回同じ[リクエスト](#クライアントとサーバ)を繰り返さなければいけない。ステートフルなやり取りでは、[クライアント](#クライアントとサーバ)は差分だけを[リクエスト](#クライアントとサーバ)すればよいが、[サーバ](#クライアントとサーバ)で[クライアント](#クライアントとサーバ)の[リクエスト](#クライアントとサーバ)を記憶しておかなければならない。

アプリケーション状態は**セッション状態**とも呼ばれる。**セッション**とはシステムにログインしてからログアウトするまでの一連の操作のことをいい、この一連の操作の間の状態はアプリケーション状態である。

ステートフルな[アーキテクチャ](./03_rest.ja.md#アーキテクチャスタイル)では、[クライアント](#クライアントとサーバ)の数が増えた場合に、保持しなければいけないアプリケーション状態も増加する。そのため、スケールアウトさせることが難しい。

ステートレスな[アーキテクチャ](./03_rest.ja.md#アーキテクチャスタイル)は冗長であるが、スケーラビリティの面で大きな威力を発揮する。[クライアント](#クライアントとサーバ)は毎回[リクエスト](#クライアントとサーバ)の処理に必要な情報をすべて含んだ、**自己記述的メッセージ**を用いてステートレス性を実現している。

ステートレスな[アーキテクチャ](./03_rest.ja.md#アーキテクチャスタイル)の欠点は以下の通り。

- パフォーマンスの低下<br>送信するデータ量が多くなるため、ネットワーク帯域を消費する。また、認証処理などのサーバ負荷の問題もある。
- 通信エラーへの対処<br>ネットワークトラブルが起きたときにその[リクエスト](#クライアントとサーバ)が処理されたかどうかがわからない。


## HTTPメソッド

### HTTPの8つのメソッド

| メソッド | 意味                                                     |
| -------- | -------------------------------------------------------- |
| GET      | リソースの取得                                           |
| POST     | 子リソースの作成、リソースへのデータの追加、その他の処理 |
| PUT      | リソースの更新、リソースの作成                           |
| DELETE   | リソースの削除                                           |
| HEAD     | リソースのヘッダの取得                                   |
| OPTIONS  | リソースがサポートしているメソッドの取得                 |
| TRACE    | 自分宛てにリクエストメッセージを返す（ループバック）試験 |
| CONNECT  | プロキシ動作のトンネル接続への変更                       |

### HTTPメソッドとCRUD

**HTTPメソッド**のうちGET、POST、PUT、DELETEは、これら4つで**CRUD**の性質を満たす。CRUDは、Create（作成）、Read（読み込み）、Update（更新）、Delete（削除）というデータ操作の基本となる4つの処理のことである。

### GET

**GET**は指定した[URI](./04_uri.ja.md#uriの仕様)の情報を取得するメソッド。GETリクエストに対してサーバは指定された[URI](./04_uri.ja.md#uriの仕様)に対応するデータを[レスポンス](#クライアントとサーバ)として返す。

### POST

**POST**は役割の多いメソッドである。

- 子[リソース](./03_rest.ja.md#リソース)の作成<br>ある[リソース](./03_rest.ja.md#リソース)に対する子[リソース](./03_rest.ja.md#リソース)を作成する。ブログ記事の投稿操作など。
- [リソース](./03_rest.ja.md#リソース)へのデータの追加<br>[リソース](./03_rest.ja.md#リソース)の末尾、先頭どちらにデータを追加するのかは[サーバ](#クライアントとサーバ)側の実装依存。
- ほかのメソッドでは対応できない処理<br>[URI](./04_uri.ja.md#uriの仕様)の[クエリパラメータ](./04_uri.ja.md#uriの構文)が非常に長い場合に、POSTのリクエストボディに含めるなど。

### PUT

**PUT**には2つの機能を持つ。

- [リソース](./03_rest.ja.md#リソース)の更新<br>[GET](#get)で取得した[リソース](./03_rest.ja.md#リソース)を更新する。
- [リソース](./03_rest.ja.md#リソース)の作成<br>存在しない[URI](./04_uri.ja.md#uriの仕様)に対してPUTすることで[リソース](./03_rest.ja.md#リソース)を新しく作成する。

PUTによる[リソース](./03_rest.ja.md#リソース)の作成では、[リソース](./03_rest.ja.md#リソース)の[URI](./04_uri.ja.md#uriの仕様)を[クライアント](#クライアントとサーバ)が決定することができる。そのため、[クライアント](#クライアントとサーバ)を作るプログラマが[サーバ](#クライアントとサーバ)の内部実装を熟知している必要があり、[サーバ](#クライアントとサーバ)との結合が密になる。特別な理由がない限り、[POST](#post)を用いて[リソース](./03_rest.ja.md#リソース)を作成する設計の方が望ましい。

### べき等と安全性

**べき等**とは、ある操作を何回行っても結果が同じであるという性質。[GET](#get)やHEAD、[PUT](#put)、DELETEはべき等である。

**安全性**とは、操作対象のリソースを変化させない（**副作用**がない）という性質。[GET](#get)やHEADは安全である。

[POST](#post)はべき等でも安全でもないので、二重送信への対策などを慎重にしておく必要がある。


## ステータスコード

### ステータスコードの分類

ステータスコードは3桁の数字で、先頭の数字によって5つに分類することができる。

| ステータスコードの分類    | 概要                                                         |
| ------------------------- | ------------------------------------------------------------ |
| 1xx（処理中）             | 処理が継続していることを示す。クライアントはそのままリクエストを継続するか、サーバの指示に従ってプロトコルをアップデートして再送信する。 |
| 2xx（成功）               | リクエストが成功したことを示す。                             |
| 3xx（リダイレクト）       | ほかのリソースへのリダイレクトを示す。クライアントはレスポンスメッセージのLocationヘッダを見て新しいリソースへ接続する。 |
| 4xx（クライアントエラー） | クライアントエラーを示す。原因はクライアント側にあり、エラーを解消しない限りは正常な結果が得られない。 |
| 5xx（サーバエラー）       | サーバエラーを示す。サーバ側の原因を解決すれば同一のリクエストを再送信して正常な結果が得られる可能性がある。 |

### 頻出のステータスコード

| ステータスコード          | 概要                                                         |
| ------------------------- | ------------------------------------------------------------ |
| 200 OK                    | リクエストが成功したことを示す。                             |
| 201 Created               | リソースを新たに作成したことを示す。                         |
| 301 Moved Permanently     | リクエストで指定したリソースが新しいURIに移動したことを示す。古いURIを保ちつつ新しいURIに移行する際に用いられる。 |
| 303 See Other             | リクエストに対する処理結果が別のURIで取得できることを示す。POSTでリソースを操作した結果をGETで返す場合など。 |
| 400 Bad Request           | リクエストの構文やパラメータが間違っていることを示す。適切なクライアントエラーがない場合にも用いられる。 |
| 401 Unauthorized          | リクエストの認証情報が不適切であることを示す。               |
| 404 Not Found             | 指定したリソースが見つからなかったことを示す。               |
| 500 Internal Server Error | サーバ側に何らかの異常が生じていて、正しいレスポンスが返せないことを示す。適切なサーバエラーがない場合にも用いられる。 |
| 503 Service Unavailable   | サーバがメンテナンスなどで一時的にアクセスできないことを示す。 |


## HTTPヘッダ

HTTPヘッダはメッセージのボディに対する付加的な情報（**メタデータ**）を表現する。

| ヘッダ                       | 概要                                                         |
| ---------------------------- | ------------------------------------------------------------ |
| `Date`                       | グリニッジ標準時（Greenwich Mean Time、**GMT**）を表す。     |
| `Content-Type`               | [MIMEメディアタイプ](./appx_reference.ja.md#mimeタイプ)の指定。`carset`で文字エンコーディングを指定できるものもある。 |
| `Content-Language`           | リソースの自然言語を**言語タグ**で指定。日本語（日本）なら`ja-JP`、英語（アメリカ）なら`en-US`、英語（イギリス）なら`en-GB`。 |
| `Accept`                     | クライアントが処理できるメディアタイプをサーバに伝える。     |
| `Accept-Charset`             | クライアントが処理できる文字エンコーディングをサーバに伝える。 |
| `Accept-Language`            | クライアントが処理できる言語タグをサーバに伝える。           |
| `Content-Length`             | メッセージが持つボディのサイズ。                             |
| `Transfer-Encoding: chunked` | ボディを分割してチャンク転送することを指定。                 |
| `WWW-Authenticate`           | サーバがクライアントに提供する認証方式を指定。**Basic認証**であれば、ユーザ名とパスワードを`:`で連結し、**Base64エンコード**して受け渡す。 |
