# 『同期処理』ノート

（最終更新： 2023-08-31）


## 目次

1. [レースコンディション](#レースコンディション)
	1. [クリティカルセクション](#クリティカルセクション)
1. [同期処理](#同期処理)
	1. [スピンロック](#スピンロック)
	1. [ミューテックス](#ミューテックス)
	1. [セマフォ](#セマフォ)
	1. [条件変数](#条件変数)
	1. [バリア同期](#バリア同期)
	1. [Readers/Writerロック](#readerswriterロック)
	1. [ロックフリー](#ロックフリー)
	1. [ウェイトフリー](#ウェイトフリー)
1. [アトミック処理](#アトミック処理)
	1. [Compare and Swap](#compare-and-swap)
	1. [Test and Set](#test-and-set)
	1. [Load-Link/Store-Conditional](#load-linkstore-conditional)
1. [排他制御](#排他制御)


## レースコンディション

**レースコンディション**（**競合状態**）は、複数の[プロセス](./concurrency_and_parallelism.md#プロセス)が並行して共有リソースにアクセスした結果引き起こされる、予期しない異常な状態。並行[プログラミング](../../../_/chapters/programming.md#プログラミング)においては、いかにレースコンディションを引き起こさずに正しく[プログラミング](../../../_/chapters/programming.md#プログラミング)するかが課題の1つとなる。

### クリティカルセクション

**クリティカルセクション**は、[レースコンディション](#レースコンディション)を引き起こす[プログラム](../../../_/chapters/programming.md#プログラミング)の[コード](../../../_/chapters/programming.md#ソースコード)ブロック。クリティカルセクションを正しく実装するためには、[排他制御](#排他制御)などの[同期機構](#同期機構)を適切に使用する必要がある。


## 同期処理

**同期処理**は、複数の[プロセス](./concurrency_and_parallelism.md#プロセス)が協調して動作する際に、[クリティカルセクション](#クリティカルセクション)の実行順序やタイミングを制御するための手段。[レースコンディション](#レースコンディション)やデータの不整合を回避し、安定した並行処理を実現するために用いられる。ただし、過度な同期処理の適用は性能低下を引き起こす場合もあるため、注意が必要となる。同期処理機構には、[ミューテックス](#ミューテックス)や[セマフォ](#セマフォ)、[条件変数](#条件変数)などがある。

### スピンロック

**スピンロック**は、共有リソースのロックが獲得できるまで、空きができているかをポーリングして確認する方法で、[ミューテックス](#ミューテックス)の実装などに用いられる。スピンロック用の[API](../../../../computer/software/_/chapters/middleware.md#api)は典型的に、ロック獲得用とロック開放用の2つが提供されており、それぞれ以下のような処理を行う。

- ロック獲得用: 共有変数への[ポインタ](../../../_/chapters/data_type.md#ポインタ型)を受け取り、[TAS](#test-and-set)を用いてロックを獲得できるまでループする
- ロック開放用: 共有変数への[ポインタ](../../../_/chapters/data_type.md#ポインタ型)を受け取り、[tas_release](#test-and-set)を呼び出す

[アトミック処理](#アトミック処理)は実行速度上のペナルティが大きいので、[TAS](#test-and-set)をループで呼び出すのではなく、事前にロックの状態をループでチェックしておいてから最後に[TAS](#test-and-set)を呼び出す**Test and Test and Set**(**TTAS**)を利用した実装が多い。

### ミューテックス

**ミューテックス**(**mutex**: Mutual exclusion)は、[クリティカルセクション](#クリティカルセクション)を実行可能な[プロセス](./concurrency_and_parallelism.md#プロセス)の数を1つに制限する[同期処理](#同期処理)。共有リソースへのアクセスを制御するためのフラグを使用し、ロックの獲得・開放を行う。ミューテックスは、同時アクセスプロセス数を1にした[セマフォ](#セマフォ)と同じである（**バイナリセマフォ**）。

### セマフォ

**セマフォ**(**semaphore**)は、[ミューテックス](#ミューテックス)をより一般化したものであり、同時に複数の[プロセス](./concurrency_and_parallelism.md#プロセス)が共有リソースにアクセスできるようにする[同期処理](#同期処理)。複数の[プロセス](./concurrency_and_parallelism.md#プロセス)が共有リソースにアクセスできるため、[ミューテックス](#ミューテックス)では防げた[レースコンディション](#レースコンディション)が防げなくなる可能性がある。

### 条件変数

**条件変数**は、[プロセス](./concurrency_and_parallelism.md#プロセス)間で共有しているリソースが特定の条件を満たすまで待機する[同期処理](#同期処理)。[ミューテックス](#ミューテックス)で保護されるデータ構造が特定条件を満たすまで効率的に待機するためのメカニズムを提供し、実行時の[オーバヘッド](../../../../system/_/chapters/system_performance_evaluation.md#オーバヘッド)も削減することができる。


## アトミック処理

**アトミック処理**（**不可分操作**）は、それ以上は分割不可能な処理で、その処理の途中状態を[システム](../../../../system/_/chapters/system.md#システム)的に観測することができず、もしその処理が失敗した場合は完全に処理前の状態に復元される。現代的な[同期処理](#同期処理)のほとんどはこのアトミック処理を利用している。

### Compare and Swap

**Compare and Swap**(**CAS**)は、[アトミック処理](#アトミック処理)のひとつで、共有変数の値を比較して条件が成立する場合に新しい値を設定するという操作。この操作は次のようなステップで構成される。

1. 共有変数の現在の値を読み込む
1. 読み込んだ値と目的の値を比較する
1. もし読み込んだ値と目的の値が一致する場合、新しい値を共有変数に設定する

この処理は[セマフォ](#セマフォ)や[ロックフリー](#ロックフリー)な構造の実装に利用される。

### Test and Set

**Test and Set**(**TAS**)は、[アトミック処理](#アトミック処理)のひとつで、共有変数の値を読み込んで、その値を設定するという操作。この操作は次のようなステップで構成される。

1. 共有変数の現在の値を読み込む
1. 読み込んだ値を保存する
1. 新しい値を共有変数に設定する

この処理は[ロックフリー](#ロックフリー)で高性能なデータ構造の実装に利用される。TASにより設定された値をリセットするには、 `tas_release` を使用する。

### Load-Link/Store-Conditional

**Load-Link/Store-Conditional**(**LL/SC**)は、[アトミック処理](#アトミック処理)のひとつで、[共有メモリ](../../../../computer/linux/_/chapters/process_and_job.md#共有メモリ)へのアクセス制御や[ロックフリー](#ロックフリー)な構造の実装に利用される。この操作は次のようなステップで構成される。

1. **Load-Link**: [共有メモリ](../../../../computer/linux/_/chapters/process_and_job.md#共有メモリ)の値を読み込み、リンクを設定する
1. 読み込んだ値に対して任意の操作を行う（この間、他の[プロセス](./concurrency_and_parallelism.md#プロセス)も値にアクセスすることができる）
1. **Store-Conditional**: [共有メモリ](../../../../computer/linux/_/chapters/process_and_job.md#共有メモリ)の値を更新する前に、リンク変化していないかを確認し、変化していなければ更新を行う


## 排他制御

**排他制御**は、複数の[プロセス](./concurrency_and_parallelism.md#プロセス)が協調して動作する際に、共有リソースや共有データへのあ同時アクセスを制限し、[レースコンディション](#レースコンディション)やデータの不整合を防ぐための手法。排他制御は、正確なタイミングで適切な[同期処理](#同期処理)を使用することによって実現できる。
