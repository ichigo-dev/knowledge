# 『アンチパターン』ノート

（最終更新： 2023-10-21）


## 目次

1. [EAV](#eav)
	1. [シングルテーブル継承](#シングルテーブル継承)
	1. [具象テーブル継承](#具象テーブル継承)
	1. [クラステーブル継承](#クラステーブル継承)
	1. [半構造化データ](#半構造化データ)
1. [ポリモーフィック関連](#ポリモーフィック関連)
	1. [交差テーブル](#交差テーブル)


## EAV

**EAV**(Entity Attribute Value)は、属性と値の対応関係を表す[テーブル](./rdb.md#テーブル)で、多様なデータを効果的に保存する方法として使用されるパターン。特に、属性の数や種類が固定されていない場合に有用であるが、問題点も多いため[アンチパターン](../../../../programming/_/chapters/anti_patterns.md#アンチパターン)とされている。

以下は典型的なEAVの[テーブル](./rdb.md#テーブル)構造。

| ID | Entity ID | Attribute | Value         |
| -- | --------- | --------- | ------------- |
| 1  | 1         | 商品名    | サンプルA     |
| 2  | 1         | 価格      | 10,000        |
| 3  | 1         | 評価      | 4.5           |
| 4  | 1         | 分類      | ガジェット    |
| 5  | 1         | 保証期間  | 2年           |
| 6  | 2         | 商品名    | サンプルB     |
| 7  | 2         | 価格      | 5,000         |
| 8  | 2         | 評価      | 3             |
| 9  | 2         | 分類      | 家具          |
| 10 | 2         | サイズ    | 400mm x 300mm |

EAVを採用するデメリットとしては、以下のようなものが挙げられる。

- パフォーマンスの低下: データの取得のための[クエリ](./sql.md#クエリ)が複雑になりがちで、大規模な[データベース](./database.md#データベース)だとデータ量が増加してパフォーマンスが低下する
- データの一貫性: 同じエンティティに対して同じ属性が複数存在することが可能になってしまうなど、データの混乱や正確性の低下を引き起こす
- データ型の制限: 全てのデータをひとつの[カラム](./rdb.md#カラム)に格納するため、どのようなデータであっても文字列として格納しなければいけない
- 必須属性: [レコード](./rdb.md#レコード)自体が[カラム](./rdb.md#カラム)の役割をしているため、[NOT NULL](./rdb.md#not-null)によりデータの存在を必須とすることができない

### シングルテーブル継承

**シングルテーブル継承**は、[データベース](./database.md#データベース)設計の[アンチパターン](../../../../programming/_/chapters/anti_patterns.md#アンチパターン)である[EAV](#eav)の解決策のひとつで、考えうる属性を全て[カラム](./rdb.md#カラム)に格納した[テーブル](./rdb.md#テーブル)を利用する方法。ただし、新しい属性が必要になったときに[カラム](./rdb.md#カラム)の追加が必要になったり、種別によって必須の[カラム](./rdb.md#カラム)といったものを制約できないなどの問題点がある。

| ID | 商品名    | 価格  | 分類       | 保証期間 | サイズ        |
| -- | --------- | ----- | ---------- | -------- | ------------- |
| 1  | サンプルA | 10000 | ガジェット | 2年      |               |
| 2  | サンプルB | 5000  | 家具       |          | 400mm x 300mm |

### 具象テーブル継承

**具象テーブル継承**は、[データベース](./database.md#データベース)設計の[アンチパターン](../../../../programming/_/chapters/anti_patterns.md#アンチパターン)である[EAV](#eav)の解決策のひとつで、[シングルテーブル継承](#シングルテーブル継承)を種別ごとに分離する方法。共通項目と特有項目の区別が明確でなかったり、共通項目を追加する際に複数の[テーブル](./rdb.md#テーブル)への変更が必要になるといった問題がある。

- ガジェットテーブル

| ID | 商品名    | 価格  | 保証期間 |
| -- | --------- | ----- | -------- |
| 1  | サンプルA | 10000 | 2年      |

- 家具テーブル

| ID | 商品名    | 価格 | サイズ        |
| -- | --------- | ---- | ------------- |
| 1  | サンプルB | 5000 | 400mm x 300mm |

### クラステーブル継承

**クラステーブル継承**は、[データベース](./database.md#データベース)設計の[アンチパターン](../../../../programming/_/chapters/anti_patterns.md#アンチパターン)である[EAV](#eav)の解決策のひとつで、[具象テーブル継承](#具象テーブル継承)から共通項目の[テーブル](./rdb.md#テーブル)分ける方法。基本的には[EAV](#eav)の解決策としてはこのような構造が好ましい。

- 商品テーブル

| ID | 商品名    | 価格  | 分類       |
| -- | --------- | ----- | ---------- |
| 1  | サンプルA | 10000 | ガジェット |
| 2  | サンプルB | 5000  | 家具       |

- ガジェットテーブル

| ID | 商品ID | 保証期間 |
| -- | ------ | -------- |
| 1  | 1      | 2年      |

- 家具テーブル

| ID | 商品ID | サイズ        |
| -- | ------ | ------------- |
| 1  | 1      | 400mm x 300mm |

### 半構造化データ

**半構造化データ**は、[データベース](./database.md#データベース)設計の[アンチパターン](../../../../programming/_/chapters/anti_patterns.md#アンチパターン)である[EAV](#eav)の解決策のひとつで、共通部分は[カラム](./rdb.md#カラム)として格納し、特有部分はテキスト形式(JSONなど)で格納する方法。頻繁に属性が加わったり、動的に属性を変動させたい場合には有効であることもあるが、基本的には[EAV](#eav)と同様の問題がつきまとう。

| ID | 商品名    | 価格  | 分類       | 属性                          |
| -- | --------- | ----- | ---------- | ----------------------------- |
| 1  | サンプルA | 10000 | ガジェット | { "保証期間": "2年" }         |
| 2  | サンプルB | 5000  | 家具       | { "サイズ": "400mm x 300mm" } |


## ポリモーフィック関連

**ポリモーフィック関連**は、1つの[テーブル](./rdb.md#テーブル)が複数の親[テーブル](./rdb.md#テーブル)を持つような設計で、[データベース](./database.md#データベース)設計の[アンチパターン](../../../../programming/_/chapters/anti_patterns.md#アンチパターン)のひとつ。[外部キー制約](./rdb.md#foreign-key)が利用できず、[クエリ](./sql.md#クエリ)が非効率になってしまうという問題がある。

[EAV](#eav)は1つの[カラム](./rdb.md#カラム)に状態を詰め込んで、[レコード](./rdb.md#レコード)単位で状態を隠しているが、ポリモーフィック関連は[テーブル](./rdb.md#テーブル)単位で状態を隠している。

- 個人情報テーブル

| ID | 種別 | 名前         | 住所 |
| -- | ---- | ------------ | ---- |
| 1  | 法人 | 株式会社hoge | xxx  |
| 2  | 個人 | 田中太郎     | yyy  |
| 3  | 個人 | 山田花子     | zzz  |

- 法人テーブル

| ID | 個人情報ID | 従業員数 |
| -- | ---------- | -------- |
| 1  | 1          | 2        |

- 個人テーブル

| ID | 個人情報ID | 表示名 |
| -- | ---------- | ------ |
| 1  | 2          | fuga   |
| 2  | 3          | bar    |

### 交差テーブル

**交差テーブル**は、ある[テーブル](./rdb.md#テーブル)と別の[テーブル](./rdb.md#テーブル)との関連性を表す[テーブル](./rdb.md#テーブル)で、[データベース](./database.md#データベース)設計の[アンチパターン](../../../../programming/_/chapters/anti_patterns.md#アンチパターン)である[ポリモーフィック関連](#ポリモーフィック関連)の解決策として用いられる。

- 個人情報テーブル

| ID | 名前         | 住所 |
| -- | ------------ | ---- |
| 1  | 株式会社hoge | xxx  |
| 2  | 田中太郎     | yyy  |
| 3  | 山田花子     | zzz  |

- 法人・個人情報テーブル

| ID | 法人ID | 個人情報ID |
| -- | ------ | ---------- |
| 1  | 1      | 1          |

- 法人テーブル

| ID | 従業員数 |
| -- | -------- |
| 1  | 2        |

- 個人・個人情報テーブル

| ID | 個人ID | 個人情報ID |
| -- | ------ | ---------- |
| 1  | 1      | 2          |
| 2  | 2      | 3          |

- 個人テーブル

| ID | 表示名 |
| -- | ------ |
| 1  | fuga   |
| 2  | bar    |

