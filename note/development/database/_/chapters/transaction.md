# 『トランザクション』ノート

（最終更新： 2023-10-22）

## 目次

1. [トランザクション](#トランザクション)
	1. [コミット](#コミット)
	1. [ロールバック](#ロールバック)
	1. [セーブポイント](#セーブポイント)
1. [ロック](#ロック)
	1. [共有ロック](#共有ロック)
	1. [排他ロック](#排他ロック)
	1. [テーブルロック](#テーブルロック)
	1. [ページロック](#ページロック)
	1. [レコードロック](#レコードロック)
	1. [ロックタイムアウト](#ロックタイムアウト)
	1. [デッドロック](#デッドロック)
	1. [ギャップロック](#ギャップロック)
	1. [ネクストキーロック](#ネクストキーロック)
1. [アイソレーションレベル](#アイソレーションレベル)
	1. [シリアライザブル](#シリアライザブル)
	1. [リピータブルリード](#リピータブルリード)
	1. [リードアンコミッテッド](#リードアンコミッテッド)
	1. [リードコミッテッド](#リードコミッテッド)
	1. [ファントム](#ファントム)
	1. [ファジーリード](#ファジーリード)
	1. [ダーティリード](#ダーティリード)


## トランザクション

**トランザクション**は、複数の[SQL](./sql.md#sql)を1つの作業単位としてまとめて実行する処理。トランザクションは[SQL](./sql.md#sql)文をグループ化するためのメカニズムであり、すべての文が成功したか、すべての文が失敗したかの2つの結果しか起こり得ない。

トランザクション中は[ロック](#ロック)機構により他のトランザクションが実行できなくなるが、トランザクションを並行して複数実行できるように意識することで処理は高速になる。

### コミット

**コミット**は、[トランザクション](#トランザクション)が開始されてからの操作を確定し、[トランザクション](#トランザクション)を終了する命令。

### ロールバック

**ロールバック**は、[トランザクション](#トランザクション)が開始されてからの操作を取り消し、[トランザクション](#トランザクション)を終了する命令。

### セーブポイント

**セーブポイント**は、[トランザクション](#トランザクション)が異常終了して[ロールバック](#ロールバック)するときに、最初の状態まで戻すのではなく途中の状態に戻したいといった場合に用いる機能。


## ロック

**ロック**は、データリソースが同時に使用されることで整合性が失われることを防ぐため、[トランザクション](#トランザクション)がデータリソースを占有する機構。ロックされているデータに対して、別の[トランザクション](#トランザクション)がロックをかけようとした場合、前のロックが解除されるまで待機する必要がある。

### 共有ロック

**共有ロック**(Shared Lock)は、複数の[トランザクション](#トランザクション)で共有することができる[ロック](#ロック)で、同じリソースの読み込みはできるが、書き込みはできない。

### 排他ロック

**排他ロック**(Excluded lock)は、ひとつの[トランザクション](#トランザクション)によって占有される[ロック](#ロック)で、他の[トランザクション](#トランザクション)はリソースに対して読み込みも書き込みもできない。

### テーブルロック

**テーブルロック**（**表ロック**）は、[テーブル](./rdb.md#テーブル)内のすべてのデータを変更できないようにする[ロック](#ロック)。

### ページロック

**ページロック**は、[テーブル](./rdb.md#テーブル)内の同じページ（一般に2〜16KBのメモリセグメント）のデータを変更できないようにする[ロック](#ロック)。

### レコードロック

**レコードロック**（**行ロック**）は、[テーブル](./rdb.md#テーブル)内の同じ[レコード](./rdb.md#レコード)を変更できないようにする[ロック](#ロック)。

### ロックタイムアウト

**ロックタイムアウト**は、[ロック](#ロック)中のデータに別の[トランザクション](#トランザクション)が[ロック](#ロック)をかけようとして[ロック](#ロック)待ちの状態となった場合に、待ち時間の上限となる時間。ロックタイムアウトがないと、[デッドロック](#デッドロック)が発生したときに[トランザクション](#トランザクション)が解除できなくなってしまう。

### デッドロック

**デッドロック**は、複数の[トランザクション](#トランザクション)が互いに[ロック](#ロック)を掛け合うような状態となり、どちらの[トランザクション](#トランザクション)もそれより先に処理を進めることができなくなる状態。デッドロックの状態となると、[トランザクション](#トランザクション)は[ロックタイムアウト](#ロックタイムアウト)に達し、[トランザクション](#トランザクション)が解除される（[ロックタイムアウト](#ロックタイムアウト)時は、設定に応じた挙動となる。自動的に[ロールバック](#ロールバック)するなど。）。

### ギャップロック

**ギャップロック**は、[MySQL](./database.md#rdbms)特有の[ロック](#ロック)で、[インデックス](./index.md#インデックス)がはられた[カラム](./rdb.md#カラム)について範囲検索を行った場合に、その間隙自体に適用される[排他ロック](#排他ロック)。ただし、[排他ロック](#排他ロック)ではあるものの、ギャップロックは他のギャップロックをブロックしない。

これは[アイソレーションレベル](#アイソレーションレベル)が、[リピータブルリード](#リピータブルリード)か[シリアライザブル](#シリアライザブル)のときに、[ファントム](#ファントム)を防ぐために発生する。最初の範囲検索による `SELECT` の後に、その範囲内に別の[レコード](./rdb.md#レコード)が挿入されると[ファントム](#ファントム)が発生するので、その範囲自体に[ロック](#ロック)をかけることでこれを防ぐ。

例えば、 `SELECT` の条件として `WHERE` 句に `ID > 3 AND ID < 8` を指定した場合、 `ID = 4` 〜 `ID = 7` の範囲がギャップロックの対象となる。また、 `WHERE` 句に `ID > 5` を指定した場合、 `AUTO INCREMENT` で新しい行を `INSERT` することができなくなる。

### ネクストキーロック

**ネクストキーロック**は、[MySQL](./database.md#rdbms)特有の[ロック](#ロック)で、存在しない[レコード](./rdb.md#レコード)に対して範囲[ロック](#ロック)をかけようとしたときに確保される、その次に大きい[インデックス](./index.md#インデックス)値を持つ[レコード](./rdb.md#レコード)までの範囲の[ギャップロック](#ギャップロック)。ネクストキーロックは、[RDBMS](./database.md#rdbms)の実装の都合上発生してしまっている[ロック](#ロック)であり、理論上は不要な[レコード](./rdb.md#レコード)に対する[ロック](#ロック)と言える。

例えば、 `SELECT` の条件として `WHERE` 句に `ID < 10` を指定して、 `ID = 10` の[レコード](./rdb.md#レコード)がない場合、 `ID > 10` の最も近い[レコード](./rdb.mdレコード)までの[ギャップロック](#ギャップロック)が取得される。また、 `ID <= 10` の条件の場合、 `ID = 10` の[レコード](./rdb.md#レコード)が存在する場合でもネクストキーロックが発生する。

- [参考](https://norikone.hatenablog.com/entry/2018/09/12/MySQL%28InnoDB%29%E3%81%AE%E3%83%8D%E3%82%AF%E3%82%B9%E3%83%88%E3%82%AD%E3%83%BC%E3%83%AD%E3%83%83%E3%82%AF%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF%E3%81%A8%E7%AF%84%E5%9B%B2%E3%82%92%E5%9B%B3%E8%A7%A3)


## アイソレーションレベル

**アイソレーションレベル**は、[トランザクション](#トランザクション)の分離性のレベル。制限が厳しいものは並行に実行できる[トランザクション](#トランザクション)が少なくなるため、安全性は高い。制限が緩いものは並行性が高く、高速な処理ができる一方で、データの不整合性が発生しないように注意する必要がある。

### シリアライザブル

**シリアライザブル**（**直列化可能**）は、最も厳しい[アイソレーションレベル](#アイソレーションレベル)で、[トランザクション](#トランザクション)は常に1つしか実行されない。データの整合性が失われたり、[デッドロック](#デッドロック)となるケースはない一方で、実行速度は遅い。

### リピータブルリード

**リピータブルリード**（**再読み込み可能読み取り**）は、[シリアライザブル](#シリアライザブル)の次に厳しい[アイソレーションレベル](#アイソレーションレベル)で、データの読み取り時と変更時に[ロック](#ロック)がかかり、[トランザクション](#トランザクション)が終わるまで[ロック](#ロック)は解除されない。

[シリアライザブル](#シリアライザブル)では発生しない[ファントム](#ファントム)が発生する可能性がある。ただし、[RDBMS](./database.md#rdbms)によっては[ファントム](#ファントム)が発生しない。

### リードアンコミッテッド

**リードアンコミッテッド**（**コミット済み読み取り**）は、[リードコミッテッド](#リードコミッテッド)の次に緩い[アイソレーションレベル](#アイソレーションレベル)で、データの読み取り時と変更時に[ロック](#ロック)がかかり、読み込み時は[SQL](./sql.md#sql)実行後に[ロック](#ロック)が解除されるが、変更時は[トランザクション](#トランザクション)が終わるまで[ロック](#ロック)が解除されない。

[シリアライザブル](#シリアライザブル)では発生しない[ファントム](#ファントム)と[ファジーリード](#ファジーリード)が発生する可能性がある。

### リードコミッテッド

**リードコミッテッド**（**非コミット読み取り**）は、最も緩い[アイソレーションレベル](#アイソレーションレベル)で、データの変更時に[ロック](#ロック)がかかり、[トランザクション](#トランザクション)が終わるまで[ロック](#ロック)が解除されない。読み込み時には[ロック](#ロック)がかからない。

[シリアライザブル](#シリアライザブル)では発生しない[ファントム](#ファントム)と[ファジーリード](#ファジーリード)と[ダーティリード](#ダーティリード)が発生する可能性がある。

### ファントム

**ファントム**は、[トランザクション](#トランザクション)中である範囲のデータを読み込む[クエリ](./sql.md#クエリ)を複数回実行したときに、2回目以降の実行で最初の実行時よりもデータが増減する現象。[リピータブルリード](#リピータブルリード)（あるいは[リードアンコミッテッド](#リードアンコミッテッド)）よりも緩い[アイソレーションレベル](#アイソレーションレベル)では、データの読み込み時に読み込むデータの[レコードロック](#レコードロック)を取るが、その[レコードロック](#レコードロック)の範囲外で別の[トランザクション](#トランザクション)によりデータが挿入・削除される可能性があるため、ファントムが発生し得る。

### ファジーリード

**ファジーリード**（**ノーリピータブルリード**）は、[トランザクション](#トランザクション)中で同じ読み込みの[クエリ](./sql.md#クエリ)を複数実行したときに、その結果が変わる現象。[リードアンコミッテッド](#リードアンコミッテッド)よりも緩い[アイソレーションレベル](#アイソレーションレベル)では、データの読み取り後に[ロック](#ロック)が解除されるため、別の[トランザクション](#トランザクション)によってそのデータが変更されるとファジーリードが発生する。

### ダーティリード

**ダーティリード**は、ある[トランザクション](#トランザクション)の変更が[コミット](#コミット)される前に、別の[トランザクション](#トランザクション)から変更後の値を読み出せてしまう現象。[リードコミッテッド](#リードコミッテッド)では、データの読み出し時に[ロック](#ロック)を獲得しようとしないため、ダーティリードが発生し得る。
